{% load lab_filters %}
<!-- lab/templates/lab/tasks/list.html -->
<div class="space-y-6">
  <!-- Filters and Search -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
    <div
      class="flex items-center justify-between mb-4 pb-2 border-b border-gray-100"
    >
      <div class="flex items-center space-x-3">
        <i class="fas fa-tasks w-5 h-5 text-indigo-500"></i>
        <div>
          <h2 class="text-lg font-semibold text-gray-800">Tasks</h2>
          <p class="text-xs text-gray-500">
            Manage your tasks across all projects
          </p>
        </div>
      </div>
      <div class="flex space-x-2">
        <button
          class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 flex items-center"
          hx-get="{% url 'lab:task_create_standalone' %}"
          hx-target="#main-content"
          hx-push-url="true"
        >
          <i class="fas fa-plus mr-2"></i>
          New Task
        </button>
      </div>
    </div>

    <form
      hx-get="{% url 'lab:task_list' %}"
      hx-target="#task-list-container"
      hx-trigger="change"
      class="grid grid-cols-1 md:grid-cols-3 gap-4"
    >
      <!-- Project Filter -->
      <div class="relative">
        <label
          for="project-filter"
          class="block text-xs font-medium text-gray-600 mb-1"
          >Project</label
        >
        <select
          id="project-filter"
          name="project"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        >
          <option value="">All Projects</option>
          {% for project in projects %}
            <option
              value="{{ project.id }}"
              {% if current_filters.project == project.id|stringformat:"i" %}selected{% endif %}
            >
              {{ project.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- Status Filter -->
      <div class="relative">
        <label
          for="status-filter"
          class="block text-xs font-medium text-gray-600 mb-1"
          >Status</label
        >
        <select
          id="status-filter"
          name="status"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        >
          <option
            value="open"
            {% if current_filters.status == 'open' or not current_filters.status %}selected{% endif %}
          >
            Open Tasks
          </option>
          <option
            value="completed"
            {% if current_filters.status == 'completed' %}selected{% endif %}
          >
            Completed Tasks
          </option>
          <option
            value="all"
            {% if current_filters.status == 'all' %}selected{% endif %}
          >
            All Tasks
          </option>
        </select>
      </div>

      <!-- Assigned To Filter -->
      <div class="relative">
        <label
          for="assigned-to-filter"
          class="block text-xs font-medium text-gray-600 mb-1"
          >Assigned To</label
        >
        <select
          id="assigned-to-filter"
          name="assigned_to"
          class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
        >
          <option value="">Anyone</option>
          <option
            value="me"
            {% if current_filters.assigned_to == 'me' %}selected{% endif %}
          >
            Assigned to Me
          </option>
          {% for user in users %}
            <option
              value="{{ user.id }}"
              {% if current_filters.assigned_to == user.id|stringformat:"i" %}selected{% endif %}
            >
              {{ user.get_full_name|default:user.username }}
            </option>
          {% endfor %}
        </select>
      </div>
    </form>
  </div>

  <!-- Task List -->
  <div id="task-list-container" class="space-y-4">
    <!-- Task Count Summary -->
    <div class="flex flex-wrap gap-3 mb-2">
      <div
        class="px-4 py-2 bg-white rounded-lg shadow-sm flex items-center gap-2 border border-gray-200"
      >
        <span class="text-sm font-medium text-gray-500">Total:</span>
        <span class="text-sm font-bold text-gray-700">{{ tasks|length }}</span>
      </div>

      {% with open_count=tasks|filter_by_status:'open' completed_count=tasks|filter_by_status:'completed' %}
        <div
          class="px-4 py-2 bg-white rounded-lg shadow-sm flex items-center gap-2 border border-gray-200"
        >
          <span class="text-sm font-medium text-green-500">Open:</span>
          <span class="text-sm font-bold text-gray-700">{{ open_count }}</span>
        </div>
        <div
          class="px-4 py-2 bg-white rounded-lg shadow-sm flex items-center gap-2 border border-gray-200"
        >
          <span class="text-sm font-medium text-gray-500">Completed:</span>
          <span class="text-sm font-bold text-gray-700"
            >{{ completed_count }}</span
          >
        </div>
      {% endwith %}
    </div>

    <!-- Task Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for task in tasks %}
        <div
          class="bg-white rounded-lg shadow p-4 border-l-4
          {% if task.is_completed %}
            border-green-500
          {% elif task.priority == 'urgent' %}
            border-red-500
          {% elif task.priority == 'high' %}
            border-orange-500
          {% elif task.priority == 'medium' %}
            border-yellow-500
          {% else %}
            border-blue-500
          {% endif %}"
        >
          <div class="flex justify-between items-start">
            <h4
              class="font-medium {% if task.is_completed %}
                line-through text-gray-500
              {% else %}
                text-gray-900
              {% endif %}"
            >
              {{ task.title }}
            </h4>
            <span
              class="px-2 py-1 text-xs rounded-full font-medium
              {% if task.is_completed %}
                bg-green-100 text-green-800
              {% elif task.priority == 'urgent' %}
                bg-red-100 text-red-800
              {% elif task.priority == 'high' %}
                bg-orange-100 text-orange-800
              {% elif task.priority == 'medium' %}
                bg-yellow-100 text-yellow-800
              {% else %}
                bg-blue-100 text-blue-800
              {% endif %}"
            >
              {% if task.is_completed %}Completed{% else %}{{ task.priority|title }}{% endif %}
            </span>
          </div>

          <p
            class="text-sm text-gray-500 mt-1 {% if task.is_completed %}line-through{% endif %}"
          >
            {{ task.description|truncatechars:100 }}
          </p>

          <!-- Project Badge (if applicable) -->
          {% if task.project %}
            <div class="mt-2">
              <a
                href="{% url 'lab:project_detail' task.project.id %}"
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 hover:bg-indigo-200"
                hx-get="{% url 'lab:project_detail' task.project.id %}"
                hx-target="#main-content"
                hx-push-url="true"
              >
                <i class="fas fa-project-diagram mr-1"></i>
                {{ task.project.name }}
              </a>
            </div>
          {% endif %}

          <!-- Related Item (if applicable) -->
          {% if task.content_object %}
            <div class="mt-2 text-xs">
              <span class="text-gray-500">Related to:</span>
              <a
                href="#"
                class="font-medium text-blue-600 hover:text-blue-800"
                {% if task.content_type.model == 'individual' %}
                  hx-get="{% url 'lab:individual_detail' task.object_id %}"
                  hx-target="#main-content" hx-push-url="true"
                {% elif task.content_type.model == 'sample' %}
                  hx-get="{% url 'lab:sample_detail' task.object_id %}"
                  hx-target="#main-content" hx-push-url="true"
                {% endif %}
              >
                {{ task.content_object }}
                {% if task.content_type.model == 'individual' %}
                  (Individual)
                {% elif task.content_type.model == 'sample' %}
                  (Sample)
                {% elif task.content_type.model == 'sampletest' %}
                  (Test)
                {% endif %}
              </a>
            </div>
          {% endif %}

          <div class="mt-3 text-xs text-gray-500">
            <div>
              <i class="fas fa-user mr-1"></i>
              {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
            </div>

            {% if task.is_completed %}
              <div>
                <i class="fas fa-check-circle mr-1"></i>
                Completed: {{ task.completed_at|date:"d M Y" }}
              </div>
            {% elif task.due_date %}
              <div
                {% if task.due_date < now %}class="text-red-600 font-semibold"{% endif %}
              >
                <i class="fas fa-calendar-alt mr-1"></i>
                Due: {{ task.due_date|date:"d M Y H:i" }}
              </div>
            {% endif %}

            <div>
              <i class="fas fa-flag mr-1"></i>
              Target: {{ task.target_status.name }}
            </div>
          </div>

          {% if not task.is_completed %}
            <div class="mt-3 flex justify-end">
              <button
                class="bg-green-500 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded"
                hx-post="{% url 'lab:task_complete' task.pk %}"
                hx-prompt="Add completion notes (optional):"
                hx-target="#task-list-container"
                hx-swap="innerHTML"
              >
                Complete
              </button>
            </div>
          {% endif %}
        </div>
        {% empty %}
        <div class="col-span-3 bg-white p-8 rounded-lg shadow text-center">
          <i class="fas fa-clipboard-list text-gray-300 text-5xl mb-3"></i>
          <h3 class="text-xl font-medium text-gray-700 mb-1">No tasks found</h3>
          <p class="text-gray-500 mb-4">
            {% if current_filters.status == 'completed' %}
              You haven't completed any tasks yet.
            {% else %}
              Your task list is empty.
            {% endif %}
          </p>
          <button
            class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            hx-get="{% url 'lab:task_create_standalone' %}"
            hx-target="#main-content"
            hx-push-url="true"
          >
            <i class="fas fa-plus mr-2"></i>
            Create a Task
          </button>
        </div>
      {% endfor %}
    </div>
  </div>
</div>
