{% load lab_filters %}
<div id="plot-container-{{ plot_data.id }}" 
     class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6"
     {% if not plot_data.chart_data %}
     hx-get="{% url 'lab:plots' %}?chart_id={{ plot_data.id }}"
     hx-trigger="load"
     hx-swap="outerHTML"
     :hx-vals="getGlobalFiltersHxVals()"
     {% endif %}
     >
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
        <i class="fas fa-{{ plot_data.icon|default:'chart-bar' }} text-indigo-500 mr-2"></i>
        {{ plot_data.title }}
      </h3>
      <div class="flex items-center space-x-2">
        <button id="btn-png-{{ plot_data.id }}" type="button" class="inline-flex items-center px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
            <i class="fas fa-file-image mr-1"></i> PNG
        </button>
        <button id="btn-svg-{{ plot_data.id }}" type="button" class="inline-flex items-center px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
            <i class="fas fa-file-code mr-1"></i> SVG
        </button>

        {% if plot_data.id == 'institution' %}
        <span class="text-xs text-gray-600 dark:text-gray-300">Other Threshold</span>
        <select
          name="institute_threshold"
          class="text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-2 py-1"
          hx-get="{% url 'lab:plots' %}?chart_id={{ plot_data.id }}"
          hx-target="#plot-container-{{ plot_data.id }}"
          hx-swap="outerHTML"
          hx-trigger="change"
          :hx-vals="getGlobalFiltersHxVals('institute_threshold')"
        >
          <option value="1" {% if instituteThreshold == 1 %}selected{% endif %}>1</option>
          <option value="2" {% if instituteThreshold == 2 %}selected{% endif %}>2</option>
          <option value="3" {% if instituteThreshold == 3 %}selected{% endif %}>3</option>
          <option value="4" {% if instituteThreshold == 4 %}selected{% endif %}>4</option>
          <option value="5" {% if instituteThreshold == 5 %}selected{% endif %}>5</option>
          <option value="6" {% if instituteThreshold == 6 %}selected{% endif %}>6</option>
          <option value="7" {% if instituteThreshold == 7 %}selected{% endif %}>7</option>
          <option value="8" {% if instituteThreshold == 8 %}selected{% endif %}>8</option>
          <option value="9" {% if instituteThreshold == 9 %}selected{% endif %}>9</option>
          <option value="10" {% if instituteThreshold == 10 %}selected{% endif %}>10</option>
        </select>
        {% elif plot_data.id == 'hpo-terms' %}
        <button id="hpo-fullscreen-btn" type="button" class="inline-flex items-center px-2 py-1 text-xs rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600">
            <i class="fas fa-expand mr-1"></i>
            Fullscreen
        </button>
        <span class="text-xs text-gray-600 dark:text-gray-300">Other Threshold</span>
        <select
          name="hpo_threshold"
          class="text-sm rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 px-2 py-1"
          hx-get="{% url 'lab:plots' %}?chart_id={{ plot_data.id }}"
          hx-target="#plot-container-{{ plot_data.id }}"
          hx-swap="outerHTML"
          hx-trigger="change"
          :hx-vals="getGlobalFiltersHxVals('hpo_threshold')"
        >
          <option value="1" {% if hpoThreshold == 1 %}selected{% endif %}>1</option>
          <option value="2" {% if hpoThreshold == 2 %}selected{% endif %}>2</option>
          <option value="3" {% if hpoThreshold == 3 %}selected{% endif %}>3</option>
          <option value="4" {% if hpoThreshold == 4 %}selected{% endif %}>4</option>
          <option value="5" {% if hpoThreshold == 5 %}selected{% endif %}>5</option>
          <option value="6" {% if hpoThreshold == 6 %}selected{% endif %}>6</option>
          <option value="7" {% if hpoThreshold == 7 %}selected{% endif %}>7</option>
          <option value="8" {% if hpoThreshold == 8 %}selected{% endif %}>8</option>
          <option value="9" {% if hpoThreshold == 9 %}selected{% endif %}>9</option>
          <option value="10" {% if hpoThreshold == 10 %}selected{% endif %}>10</option>
        </select>
        {% endif %}
      </div>
    </div>
    <div id="plot-{{ plot_data.id }}" class="h-128">      
      <script>
        {% if plot_data.chart_data and plot_data.chart_data.data %}
          (function() {
            var plotData = {{ plot_data.chart_data|plotly_safe|safe }};
            var plotDiv = document.getElementById('plot-{{ plot_data.id }}');
            var container = document.getElementById('plot-container-{{ plot_data.id }}');
            var fsBtn = document.getElementById('hpo-fullscreen-btn');
            var pngBtn = document.getElementById('btn-png-{{ plot_data.id }}');
            var svgBtn = document.getElementById('btn-svg-{{ plot_data.id }}');
            
            if (plotDiv && plotData) {
              // Clean up the data to remove problematic template
              if (plotData.layout && plotData.layout.template) {
                delete plotData.layout.template;
              }
              // Set textinfo to show value (count) only for all pie traces
              if (plotData.data) {
                plotData.data.forEach(function(trace) {
                  if (trace.type === 'pie') {
                    trace.textinfo = 'value';
                  }
                });
              }
              
              var config = {
                responsive: true, 
                displayModeBar: true,
                displaylogo: false, // Remove Plotly watermark
                scrollZoom: {% if plot_data.id == 'hpo-terms' %}true{% else %}false{% endif %},
                modeBarButtonsToRemove: ['toImage'], // Remove default download button
              };
              
              Plotly.newPlot(plotDiv, plotData.data, plotData.layout, config);

              // Download Handlers
              if (pngBtn) {
                  pngBtn.addEventListener('click', function() {
                      Plotly.downloadImage(plotDiv, {format: 'png', scale: 3, filename: '{{ plot_data.id }}_chart_300dpi'});
                  });
              }

              if (svgBtn) {
                  svgBtn.addEventListener('click', function() {
                      Plotly.downloadImage(plotDiv, {format: 'svg', filename: '{{ plot_data.id }}_chart'});
                  });
              }

              // Fullscreen Logic for HPO Terms
              {% if plot_data.id == 'hpo-terms' %}
              function resizePlot() {
                  if (plotDiv) {
                      Plotly.Plots.resize(plotDiv);
                  }
              }
              
              function enterFullscreen() {
                  if (container.requestFullscreen) {
                      container.requestFullscreen();
                  } else if (container.webkitRequestFullscreen) {
                      container.webkitRequestFullscreen();
                  } else if (container.msRequestFullscreen) {
                      container.msRequestFullscreen();
                  }
              }
              
              function exitFullscreen() {
                  if (document.exitFullscreen) {
                      document.exitFullscreen();
                  } else if (document.webkitExitFullscreen) {
                      document.webkitExitFullscreen();
                  } else if (document.msExitFullscreen) {
                      document.msExitFullscreen();
                  }
              }
              
              function isFullscreenActive() {
                  return document.fullscreenElement === container || document.webkitFullscreenElement === container || document.msFullscreenElement === container;
              }
              
              function updateButtonUI() {
                  if (!fsBtn) return;
                  if (isFullscreenActive()) {
                      fsBtn.innerHTML = '<i class="fas fa-compress mr-1"></i>Exit Fullscreen';
                  } else {
                      fsBtn.innerHTML = '<i class="fas fa-expand mr-1"></i>Fullscreen';
                  }
              }
              
              if (fsBtn) {
                  fsBtn.addEventListener('click', function() {
                      if (isFullscreenActive()) {
                          exitFullscreen();
                      } else {
                          enterFullscreen();
                      }
                  });
              }
              
              document.addEventListener('fullscreenchange', function() {
                  // When toggling fullscreen, expand the map area and resize plot
                  if (isFullscreenActive()) {
                      container.classList.add('fixed', 'inset-0', 'z-[9999]', 'w-screen', 'h-screen', 'overflow-hidden');
                      plotDiv.style.height = 'calc(100vh - 80px)'; // Adjust for header
                  } else {
                      container.classList.remove('fixed', 'inset-0', 'z-[9999]', 'w-screen', 'h-screen', 'overflow-hidden');
                      plotDiv.style.height = ''; // Reset to default
                  }
                  updateButtonUI();
                  // Delay resize slightly to allow layout to settle
                  setTimeout(resizePlot, 50);
              });
              {% endif %}
            }
          })();
        {% elif plot_data.chart_data.empty %}
          var plotDiv = document.getElementById('plot-{{ plot_data.id }}');
          plotDiv.innerHTML = `
            <div class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400">
              <div class="text-center">
                <i class="fas fa-chart-pie text-4xl mb-2 text-gray-300 dark:text-gray-600"></i>
                <p>No data available</p>
              </div>
            </div>
          `;
        {% else %}
          var plotDiv = document.getElementById('plot-{{ plot_data.id }}');
          plotDiv.innerHTML = `
            <div class="h-full flex items-center justify-center text-gray-500 dark:text-gray-400">
              <div class="text-center">
                <i class="fas fa-circle-notch fa-spin text-4xl mb-2 text-indigo-500"></i>
                <p>Loading {{ plot_data.title }}...</p>
              </div>
            </div>
          `;
        {% endif %}
      </script>
    </div>
  </div>
