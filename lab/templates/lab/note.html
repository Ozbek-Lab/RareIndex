{% load partials %}
{% load lab_filters %}

{% partialdef list %}
  <div class="notes-list space-y-1.5" 
       @submit-note-edit.window="
         $el.querySelector(`[data-note-id='${$event.detail.noteId}']`).dispatchEvent(new CustomEvent('submit-note-edit', { detail: $event.detail }));
       "
       hx-on:htmx:afterSwap="document.body.dispatchEvent(new CustomEvent('noteCountUpdate-{{ content_type }}-{{ object.id }}'))"
       >
    {% if object.notes.all %}
      {% for note in object.notes|visible_to:user %}
        <article class="bg-white dark:bg-gray-800 shadow-sm text-xs leading-snug border border-gray-200 dark:border-gray-700 rounded {% if note.private_owner %}bg-gray-50 dark:bg-gray-700{% endif %}" 
                 x-data="{ editing: false, content: '{{ note.content|escapejs }}' }"
                 data-note-id="{{ note.id }}"
                 @submit-note-edit="
                   if ($event.detail.noteId == {{ note.id }}) {
                     $el.querySelector('form[data-note-edit-form]').dispatchEvent(new Event('submit'));
                   }
                 ">
          <div
            class="flex items-center justify-between px-2 py-1 bg-gray-50/80 dark:bg-gray-700/80 text-[11px]"
          >
            <div class="flex items-center gap-1.5">
              <span class="text-gray-700 dark:text-gray-300 font-medium"
                >{{ note.user.username }}</span
              >
              <span class="text-gray-400 dark:text-gray-500"
                >{{ note.get_created_at|date:"Y-m-d H:i"|default:"Unknown" }}</span
              >
            </div>
            {% if user == note.user %}
              <div class="flex items-center gap-1">
                <button
                  x-show="!editing"
                  class="text-gray-400 dark:text-gray-500 hover:text-blue-500 dark:hover:text-blue-400 transition-colors"
                  @click= "editing = true; $nextTick(() => $refs.editTextarea.focus())"
                  @click.stop
                >
                  <i class="fa-solid fa-pencil"></i>
                </button>
                <button
                  x-show="editing"
                  class="text-gray-400 dark:text-gray-500 hover:text-green-500 dark:hover:text-green-400 transition-colors"
                  @click= "
                    $dispatch('submit-note-edit', { noteId: {{ note.id }}, content: content });
                    editing = false;
                  "
                  @click.stop
                >
                  <i class="fa-solid fa-floppy-disk"></i>
                </button>
                <button
                  x-show="editing"
                  class="text-gray-400 dark:text-gray-500 hover:text-gray-600 dark:hover:text-gray-400 transition-colors"
                  @click= "editing = false; content = '{{ note.content|escapejs }}'"
                  @click.stop
                >
                  <i class="fa-solid fa-xmark"></i>
                </button>
                <button
                  x-show="!editing"
                  class="text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors"
                  hx-delete="{% url 'lab:note_delete' note.id %}"
                  hx-target="closest .notes-list"
                  hx-swap="innerHTML"
                  @click= "$event.stopPropagation()"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            {% endif %}
          </div>
          <div x-show="!editing" class="px-2 py-1 text-gray-700 dark:text-gray-300">
            {% if note.private_owner %}
              <span class="inline-flex items-center gap-1 text-[10px] px-1.5 py-0.5 rounded bg-gray-200 dark:bg-gray-600 text-gray-700 dark:text-gray-200 mr-1">
                <i class="fa-solid fa-lock text-[10px]"></i> Private
              </span>
            {% endif %}
            {{ note.content }}
          </div>
          <div x-show="editing" class="px-2 py-1">
            <textarea
              x-ref="editTextarea"
              x-model="content"
              class="w-full px-2 py-1 text-xs shadow-sm rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none h-[32px] bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-500"
              placeholder="Edit note..."
              required
            ></textarea>
            <form
              data-note-edit-form
              hx-post="{% url 'lab:note_update' note.id %}"
              hx-target="closest .notes-list"
              hx-swap="innerHTML"
              class="hidden"
            >
              <input type="hidden" name="content" x-bind:value="content" />
            </form>
          </div>
        </article>
      {% endfor %}
    {% else %}
      <p class="text-gray-400 dark:text-gray-500 text-xs">No notes yet.</p>
    {% endif %}

    <div class="mt-2">
      <form
        class="mt-2"
        hx-post="{% url 'lab:note_create' %}"
        hx-target="closest .notes-list"
        hx-swap="innerHTML"
        @submit= "$event.stopPropagation()"
      >
        <input type="hidden" name="content_type" value="{{ content_type }}" />
        <input type="hidden" name="object_id" value="{{ object.id }}" />
        <div class="flex items-end gap-2">
          <textarea
            name="content"
            class="flex-1 px-2 py-1 text-xs shadow-sm rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none h-[32px] bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-500"
            placeholder="Add a note..."
            required
          ></textarea>
          <label class="flex items-center gap-1 text-xs text-gray-600 dark:text-gray-300">
            <input type="checkbox" name="private" class="rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500" />
            Private
          </label>
          <button
            type="submit"
            @click= "$event.stopPropagation()"
            class="px-2 py-1 bg-blue-600 dark:bg-blue-500 text-white text-xs rounded shadow-sm hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800 transition-colors whitespace-nowrap"
          >
            Add
          </button>
        </div>
      </form>
    </div>
  </div>
{% endpartialdef %}

{% partialdef summary %}
<div
  class="flex items-center space-x-2 text-sm"
  hx-get="{% url 'lab:note_count' %}"
  hx-trigger="noteCountUpdate-{{ content_type }}-{{ object.id }} from:body"
  hx-target="closest div"
  hx-swap="outerHTML"
  hx-vals='{"object_id": "{{ object.id }}", "content_type": "{{ content_type }}"}'
>
  {% with note_count=object.notes|visible_count:user %}
    {% if note_count == 0 %}
      <div class="text-gray-400 dark:text-gray-500">
        <i class="fa-solid fa-note-sticky"></i>
      </div>
      <span class="text-gray-500 dark:text-gray-400">No notes</span>
      <span data-note-count class="hidden">0</span>
    {% else %}
      <div class="text-blue-500 dark:text-blue-400">
        <i class="fa-solid fa-note-sticky"></i>
      </div>
      <span class="font-medium text-gray-700 dark:text-gray-300"
        >{{ note_count }} Note{% if note_count != 1 %}s{% endif %}</span
      >
      <span data-note-count class="hidden">{{ note_count }}</span>
    {% endif %}
  {% endwith %}
</div>
{% endpartialdef %}

{% partialdef inline-form %}
<form
    class="mt-2"
    hx-post="{% url 'lab:note_create' %}"
    hx-target="closest .notes-list"
    hx-swap="innerHTML"
    @submit= "$event.stopPropagation()"
>
    <input type="hidden" name="content_type" value="{{ content_type }}" />
    <input type="hidden" name="object_id" value="{{ object.id }}" />
    <div class="flex items-end gap-2">
        {{ form.content }}
        <button
            type="submit"
            @click= "$event.stopPropagation()"
            class="px-2 py-1 bg-blue-600 dark:bg-blue-500 text-white text-xs rounded shadow-sm hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800 transition-colors whitespace-nowrap"
        >
            Add
        </button>
    </div>
</form>
{% endpartialdef %}

{% partialdef dropdown %}
<div x-data="{ open: false }">
  <button @click= "open = !open">{% include 'lab/note.html#summary' %}</button>
  <div x-show="open" @click.outside= "open=false">
    {% include 'lab/note.html#list' %}
  </div>
</div>
{% endpartialdef %} 