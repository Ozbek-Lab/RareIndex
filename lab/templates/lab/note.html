{% load partials %}

{% partialdef list %}
<div class="notes-list space-y-1.5">
  {% if object.notes.all %}
    {% for note in object.notes.all %}
      <article class="bg-white dark:bg-gray-800 shadow-sm text-xs leading-snug border border-gray-200 dark:border-gray-700 rounded">
        <div
          class="flex items-center justify-between px-2 py-1 bg-gray-50/80 dark:bg-gray-700/80 text-[11px]"
        >
          <div class="flex items-center gap-1.5">
            <span class="text-gray-700 dark:text-gray-300 font-medium"
              >{{ note.user.username }}</span
            >
            <span class="text-gray-400 dark:text-gray-500"
              >{{ note.created_at|date:"Y-m-d H:i" }}</span
            >
          </div>
          {% if user == note.user %}
            <button
              class="text-gray-400 dark:text-gray-500 hover:text-red-500 dark:hover:text-red-400 transition-colors"
              hx-delete="{% url 'lab:note_delete' note.id %}"
              hx-target="closest .notes-list"
              hx-swap="innerHTML"
              @click="$event.stopPropagation()"
            >
              <i class="fa-solid fa-xmark"></i>
            </button>
          {% endif %}
        </div>
        <p class="px-2 py-1 text-gray-700 dark:text-gray-300">{{ note.content }}</p>
      </article>
    {% endfor %}
  {% else %}
    <p class="text-gray-400 dark:text-gray-500 text-xs">No notes yet.</p>
  {% endif %}

  <div class="mt-2">
    <form
      class="mt-2"
      hx-post="{% url 'lab:note_create' %}"
      hx-target="closest .notes-list"
      hx-swap="innerHTML"
      @submit="$event.stopPropagation()"
    >
      <input type="hidden" name="content_type" value="{{ content_type }}" />
      <input type="hidden" name="object_id" value="{{ object.id }}" />
      <div class="flex items-end gap-2">
        <textarea
          name="content"
          class="flex-1 px-2 py-1 text-xs shadow-sm rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 resize-none h-[32px] bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 border border-gray-300 dark:border-gray-600 placeholder-gray-400 dark:placeholder-gray-500"
          placeholder="Add a note..."
          required
        ></textarea>
        <button
          type="submit"
          @click="$event.stopPropagation()"
          class="px-2 py-1 bg-blue-600 dark:bg-blue-500 text-white text-xs rounded shadow-sm hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800 transition-colors whitespace-nowrap"
        >
          Add
        </button>
      </div>
    </form>
  </div>
</div>
{% endpartialdef %}

{% partialdef summary %}
<div
  class="flex items-center space-x-2 text-sm"
  hx-get="{% url 'lab:note_count' %}"
  hx-trigger="noteCountUpdate-{{ content_type }}-{{ object.id }} from:body"
  hx-target="closest div"
  hx-swap="outerHTML"
  hx-vals='{"object_id": "{{ object.id }}", "content_type": "{{ content_type }}"}'
>
  {% with note_count=object.notes.count %}
    {% if note_count == 0 %}
      <div class="text-gray-400 dark:text-gray-500">
        <i class="fa-solid fa-note-sticky"></i>
      </div>
      <span class="text-gray-500 dark:text-gray-400">No notes</span>
    {% else %}
      <div class="text-blue-500 dark:text-blue-400">
        <i class="fa-solid fa-note-sticky"></i>
      </div>
      <span class="font-medium text-gray-700 dark:text-gray-300"
        >{{ note_count }} Note{% if note_count != 1 %}s{% endif %}</span
      >
    {% endif %}
  {% endwith %}
</div>
{% endpartialdef %}

{% partialdef inline-form %}
<form
    class="mt-2"
    hx-post="{% url 'lab:note_create' %}"
    hx-target="closest .notes-list"
    hx-swap="innerHTML"
    @submit="$event.stopPropagation()"
>
    <input type="hidden" name="content_type" value="{{ content_type }}" />
    <input type="hidden" name="object_id" value="{{ object.id }}" />
    <div class="flex items-end gap-2">
        {{ form.content }}
        <button
            type="submit"
            @click="$event.stopPropagation()"
            class="px-2 py-1 bg-blue-600 dark:bg-blue-500 text-white text-xs rounded shadow-sm hover:bg-blue-700 dark:hover:bg-blue-600 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:ring-offset-1 dark:focus:ring-offset-gray-800 transition-colors whitespace-nowrap"
        >
            Add
        </button>
    </div>
</form>
{% endpartialdef %}

{% partialdef dropdown %}
<div x-data="{ open: false }">
  <button @click="open = !open">{% include 'lab/note.html#summary' %}</button>
  <div x-show="open" @click.outside="open = false">
    {% include 'lab/note.html#list' %}
  </div>
</div>
{% endpartialdef %} 