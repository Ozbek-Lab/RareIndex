{% extends "base.html" %}
{% load render_table from django_tables2 %}

{% block content %}

<div class="flex h-[calc(100vh-64px)] bg-base-100"
     x-data="{
        filterOpen: localStorage.getItem('variantFilterSidebarOpen') === 'true',
        init() {
            this.$watch('filterOpen', val => localStorage.setItem('variantFilterSidebarOpen', val));
            const scrollPos = localStorage.getItem('variantListScroll');
            if (scrollPos) {
                this.$nextTick(() => {
                    const el = document.getElementById('main-content');
                    if (el) el.scrollTop = scrollPos;
                });
            }
        },
        saveScroll(e) {
            localStorage.setItem('variantListScroll', e.target.scrollTop);
        }
     }"
     x-init="init()"
     :class="{ 'pl-6': !sidebarOpen }">

    <!-- Filter Sidebar -->
    <aside class="w-0 border-none flex-shrink-0 border-r border-base-200 bg-base-100 z-20 transition-all duration-300"
           :class="{ 'w-0 border-none': !filterOpen, 'w-80': filterOpen }">
        <div class="h-full overflow-hidden" x-show="filterOpen" x-transition.opacity>
            {% include "lab/partials/variant_filter_sidebar.html" %}
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col w-0 overflow-hidden relative">
        <!-- Header -->
        <header class="h-16 flex items-center justify-between px-6 border-b border-base-200 bg-base-100 flex-shrink-0 z-10">
            <div class="flex items-center gap-4 flex-1">
                <button @click="filterOpen = !filterOpen" class="btn btn-ghost btn-sm btn-square">
                    <i class="fa-solid fa-filter text-lg"></i>
                </button>
                <h1 class="text-2xl font-bold text-base-content whitespace-nowrap">Variants</h1>
                <div id="table-counts" class="badge badge-lg badge-ghost">
                    {{ table.page.paginator.count }} Variants
                </div>

                <div class="max-w-md w-full ml-4">
                    <label class="input input-bordered input-sm flex items-center w-full">
                        <input type="text"
                               name="search"
                               form="variant-filter-form"
                               value="{{ request.GET.search|default:'' }}"
                               class="grow min-w-0"
                               placeholder="Search chromosome, individual, gene..."
                               hx-get="{% url 'lab:variant_list' %}"
                               hx-target="#variant-table-container"
                               hx-trigger="keyup delay:500ms changed"
                               hx-push-url="true"
                               hx-include="#variant-filter-form"
                               hx-indicator="#table-indicator" />

                        <div id="table-indicator" class="htmx-indicator">
                            <span class="loading loading-spinner loading-xs text-primary"></span>
                        </div>

                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </label>
                </div>
            </div>
        </header>

        <!-- Table Area -->
        <div class="flex-1 overflow-y-auto relative bg-base-200/50 p-6" id="main-content" @scroll.debounce.100ms="saveScroll">
            <!-- Loading Overlay -->
            <div id="table-indicator"
                 class="htmx-indicator pointer-events-none [&.htmx-request]:pointer-events-auto absolute inset-0 bg-base-100/50 z-50 flex items-center justify-center backdrop-blur-sm transition-all duration-200">
                <span class="loading loading-spinner loading-lg text-primary"></span>
            </div>

            <div class="bg-base-100 rounded-box shadow-sm border border-base-200 overflow-hidden">
                {% include "lab/partials/variant_table.html" %}
            </div>
        </div>
    </main>
</div>
{% endblock %}
