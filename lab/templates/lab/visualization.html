#TODO: Temporarily placed here

{% partialdef hpo-network-visualization-section %}
  <div id="hpo-section-wrapper">
    <div class="relative min-h-[30rem]">

      <div
        id="hpo-visualization-container"
        class="transition bg-white dark:bg-gray-800 shadow rounded-lg p-4"
        :class="{ 'opacity-50 blur-sm': isLoading }"
        @htmx:before-request= "isLoading = true"
        @htmx:after-request= "isLoading = false"
        hx-get="{% url 'lab:hpo_network_visualization' %}"
        hx-trigger="load, filters-updated from:window"
        hx-swap="innerHTML"
        :hx-vals="getHpoVals()"
      >
        {% with text="Initializing visualization..." %}
          {% include "lab/partials/partials.html#indicator" %}
        {% endwith %}
      </div>

      <div
        x-show="isLoading"
        x-transition
        class="absolute inset-0 bg-gray-400/20 dark:bg-gray-700/40 flex items-center justify-center rounded-md z-10"
        style="display: none;"
      >
        <div class="text-center text-gray-600 dark:text-gray-300">
          <p class="mb-4">Updating visualization...</p>
          <i class="fas fa-spinner fa-spin fa-2x text-blue-500"></i>
        </div>
      </div>

    </div>
  </div>
{% endpartialdef hpo-network-visualization-section %}

{% partialdef plots-section %}
  <div class="space-y-6">
    <!-- Welcome Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
        <i class="fas fa-chart-bar text-indigo-500 mr-2"></i>
        Data Visualizations
      </h2>
      <p class="text-gray-600 dark:text-gray-300 mb-4">
        Explore your laboratory data through interactive charts and graphs. This section provides various visualizations to help you understand patterns and trends in your data.
      </p>
      
      <!-- Quick Stats Cards -->
      <div id="stats-cards-loading" class="hidden text-center py-4"><span class="animate-spin inline-block w-6 h-6 border-4 border-blue-400 border-t-transparent rounded-full"></span> Loading stats...</div>
      <div id="stats-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-lg p-4 text-white">
          <div class="flex items-center">
            <i class="fas fa-users text-2xl mr-3"></i>
            <div>
              <p class="text-sm opacity-90">Total Individuals</p>
              <p class="text-2xl font-bold" id="stat-individuals">{{ individuals_count|default:"0" }}</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-lg p-4 text-white">
          <div class="flex items-center">
            <i class="fas fa-vial text-2xl mr-3"></i>
            <div>
              <p class="text-sm opacity-90">Total Samples</p>
              <p class="text-2xl font-bold" id="stat-samples">{{ samples_count|default:"0" }}</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-lg p-4 text-white">
          <div class="flex items-center">
            <i class="fas fa-flask-vial text-2xl mr-3"></i>
            <div>
              <p class="text-sm opacity-90">Total Tests</p>
              <p class="text-2xl font-bold" id="stat-tests">{{ tests_count|default:"0" }}</p>
            </div>
          </div>
        </div>
        <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-lg p-4 text-white">
          <div class="flex items-center">
            <i class="fas fa-laptop text-2xl mr-3"></i>
            <div>
              <p class="text-sm opacity-90">Total Analyses</p>
              <p class="text-2xl font-bold" id="stat-analyses">{{ analyses_count|default:"0" }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Distribution Plots -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {% for plot_data in distribution_plots %}
        {% partial plot %}
      {% endfor %}
    </div>

    <!-- Interactive Pie Chart Generator -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
        <i class="fas fa-chart-pie text-indigo-500 mr-2"></i>
        Interactive Pie Chart Generator
      </h3>
      <div class="mb-4">
        <h4 class="text-md font-semibold mb-2">Chart will be displayed here</h4>
        <div id="dynamic-pie-chart-container" class="hidden">
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <div id="dynamic-pie-chart" class="h-96"></div>
          </div>
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Model
          </label>
          <select id="model-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Select Model</option>
            <option value="Individual">Individual</option>
            <option value="Sample">Sample</option>
            <option value="Test">Test</option>
            <option value="Analysis">Analysis</option>
            <option value="Project">Project</option>
            <option value="Task">Task</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Attribute
          </label>
          <select id="attribute-select" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">Select Attribute</option>
            <option value="status__name">Status</option>
            <option value="type__name">Type</option>
            <option value="institution__name">Institution</option>
            <option value="project__name">Project</option>
          </select>
        </div>
        <div class="flex items-end">
          <button 
            id="generate-pie-chart"
            class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
            <i class="fas fa-chart-pie mr-2"></i>
            Generate Chart
          </button>
        </div>
      </div>
      <!-- Loading Indicator -->
      <div id="loading-indicator" class="htmx-indicator hidden">
        <div class="flex items-center justify-center py-4">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
          <span class="ml-2 text-gray-600">Generating chart...</span>
        </div>
      </div>
    </div>

    <!-- Interactive Controls -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
        <i class="fas fa-sliders-h text-indigo-500 mr-2"></i>
        Chart Controls
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Date Range
          </label>
          <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="7">Last 7 days</option>
            <option value="30" selected>Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Chart Type
          </label>
          <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="bar">Bar Chart</option>
            <option value="line" selected>Line Chart</option>
            <option value="pie">Pie Chart</option>
            <option value="scatter">Scatter Plot</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
            Data Source
          </label>
          <select class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="all" selected>All Data</option>
            <option value="individuals">Individuals Only</option>
            <option value="samples">Samples Only</option>
            <option value="tests">Tests Only</option>
            <option value="analyses">Analyses Only</option>
          </select>
        </div>
      </div>
      
      <div class="mt-4 flex space-x-3">
        <button class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
          <i class="fas fa-refresh mr-2"></i>
          Refresh Charts
        </button>
        <button class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
          <i class="fas fa-download mr-2"></i>
          Export Data
        </button>
      </div>
    </div>
  </div>
{% endpartialdef plots-section %}

{% partialdef hpo-network-visualization %}
  <div class="col-span-10 space-y-4">
    {% if error %}
      <div class="bg-red-100 dark:bg-red-900 p-4 rounded-lg text-red-800 dark:text-red-200">
        <b>Error:</b> {{ error }}
      </div>
    {% else %}
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
        <label for="threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300">
          Consolidation Threshold
          <span
            x-show="!isThresholdValid"
            x-transition
            class="text-red-500 dark:text-red-300 text-sm mt-1"
          >
            Please enter a number between 1 and 24.
          </span>
        </label>
        <input
          type="number"
          id="threshold"
          name="threshold"
          placeholder="{{ threshold }}"
          x-model.debounce.500ms="hpoThreshold"
          x-ref="hpoThresholdInput"
          min="1"
          max="24"
          class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-700 shadow-sm bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 placeholder-gray-400 dark:placeholder-gray-400"
        />
      </div>
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-4">
        <p class="text-sm text-gray-900 dark:text-gray-100">
          Plotting <span class="font-bold">{{ term_count }}</span> terms for
          <span class="font-bold">{{ individual_count }} individuals</span>.
        </p>
        <div
          id="plotly-div"
          style="width: 100%; height: 800px;"
          class="mt-4"
        ></div>
      </div>
      {# prettier-ignore-start #}
      <script>
        var plotData = {{ plot_json|safe }};
        var plotlyDiv = document.getElementById('plotly-div');
        if (plotlyDiv) { Plotly.newPlot(plotlyDiv, plotData.data, plotData.layout); }
      </script>
      {# prettier-ignore-end #}
    {% endif %}
  </div>
{% endpartialdef hpo-network-visualization %}
