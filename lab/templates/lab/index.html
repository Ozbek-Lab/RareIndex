{% extends "lab/base.html" %}


<style>
  /* Form field styling for better visibility */
  .form-field-wrapper input,
  .form-field-wrapper select,
  .form-field-wrapper textarea {
    @apply w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md;
    @apply bg-white dark:bg-gray-700;
    @apply text-gray-900 dark:text-gray-100;
    @apply placeholder-gray-500 dark:placeholder-gray-400;
    @apply focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent;
    @apply transition-colors duration-200;
  }

  .form-field-wrapper input:focus,
  .form-field-wrapper select:focus,
  .form-field-wrapper textarea:focus {
    @apply border-blue-500 dark:border-blue-400;
  }

  /* Dark mode specific adjustments */
  .dark .form-field-wrapper input,
  .dark .form-field-wrapper select,
  .dark .form-field-wrapper textarea {
    @apply bg-gray-700 border-gray-600 text-gray-100;
  }

  .dark .form-field-wrapper input:focus,
  .dark .form-field-wrapper select:focus,
  .dark .form-field-wrapper textarea:focus {
    @apply bg-gray-700 border-blue-400 ring-blue-400;
  }

  /* Textarea specific styling */
  .form-field-wrapper textarea {
    @apply resize-vertical min-h-[80px];
  }

  /* Select dropdown styling */
  .form-field-wrapper select {
    @apply appearance-none bg-no-repeat bg-right;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
  }

  .dark .form-field-wrapper select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23d1d5db' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
  }
</style>

{% block content %}
<div x-data="mainController()" class="flex h-screen bg-gray-50 dark:bg-gray-900">
  {{ initial_detail_html|json_script:"initial-detail-html" }}
  {{ model_name|default:''|json_script:"initial-model-name" }}
  {{ app_label|default:''|json_script:"initial-app-label" }}
  {{ item.pk|default:''|json_script:"initial-pk" }}
  {{ display_preferences|json_script:"display-preferences" }}
  {% include "lab/sidebar.html" %}
  <main class="flex-1 overflow-y-auto p-6">
    <div id="main-content">
      <div id="modal-root"></div>
      <!-- Main content area for HTMX operations -->
      <div class="fixed top-1/2 right-4 z-50 flex flex-col items-end space-y-2">
        <button @click="open = true" type="button"
          class="focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:text-gray-100" aria-label="Open filters">
          <i class="fa-solid fa-filter"></i>
        </button>
        <!-- Clear Filters Button -->
        <button x-show="Object.values(filters).some(v => v  && (Array.isArray(v) ? v.length > 0 : true))"
          @click="filters = {}; window.dispatchEvent(new CustomEvent('filters-updated', { detail: { filters: {} } }));"
          class="focus:outline-none focus:ring-2 focus:ring-indigo-400 dark:text-gray-100" type="button">
          <i class="fa-solid fa-filter-circle-xmark"></i>
        </button>
      </div>
      {% include "lab/partials/drawer.html#drawer" %}
      <!-- Detail View Container -->
      <div x-show="activeItem && activeItem.startsWith('detail-')" id="detail-view" class="relative">
        <template x-if="detailHtml">
          <div x-html="detailHtml"></div>
        </template>
        <template x-if="!detailHtml">
          <div class="flex items-center justify-center h-full min-h-[200px]">
            <i class="fa-solid fa-circle-notch fa-spin text-4xl text-gray-400"></i>
          </div>
        </template>

      </div>
      <!-- Hide main content when detail is open -->
      <div x-show="!activeItem || !activeItem.startsWith('detail-')">
        <div x-show="activeItem === 'home'" id="plots-content" hx-get="{% url 'lab:plots' %}"
          hx-trigger="load, filters-updated from:window throttle:200ms" :hx-vals="getGlobalFiltersHxVals()">
          {% with view="page" %}
          {% include "lab/plots.html#plots-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'overview'">
          <div class="grid grid-cols-4 gap-4 relative">
            {% include "lab/overview.html#overview" %}
          </div>
        </div>
        <div x-show="activeItem === 'individual'">
          {% with title='Individuals' icon_class='fa-person' model_name='Individual' app_label='lab' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'sample'">
          {% with title='Samples' icon_class='fa-vial' model_name='Sample' app_label='lab' select='true' field_name='sample_type' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'test'">
          {% with title='Tests' icon_class='fa-flask-vial' model_name='Test' app_label='lab' select='true' field_name='test_type' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'analysis'">
          {% with title='Analyses' icon_class='fa-laptop' model_name='Analysis' app_label='lab' select='true' field_name='analysis_type' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'institution'">
          {% with title='Institutions' icon_class='fa-building-columns' model_name='Institution' app_label='lab' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'project'">
          {% with title='Projects' icon_class='fa-diagram-project' model_name='Project' app_label='lab' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'task'">
          {% with title='Tasks' icon_class='fa-list-check' model_name='Task' app_label='lab' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'variant'">
          {% with title='Variants' icon_class='fa-dna' model_name='Variant' app_label='variant' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <div x-show="activeItem === 'hpo-term'">
          {% with title='HPO Terms' icon_class='fa-stethoscope' model_name='Term' app_label='ontologies' view="page" %}
          {% include "lab/partials/partials.html#search-section" %}
          {% endwith %}
        </div>
        <!-- Only create the HPO network DOM when the page is active -->
        <template x-if="activeItem === 'hpo-network-visualization'">
          <div>
            {% with view="page" %}
            <div x-data="hpoController()"
              x-init="$nextTick(() => { const el = document.getElementById('hpo-visualization-container'); if (el && window.htmx) { htmx.process(el); } })">
              {% include "lab/plots.html#hpo-network-visualization-section" %}
            </div>
            {% endwith %}
          </div>
        </template>
        <div x-show="activeItem === 'notifications'" id="notifications-content">
          <!-- Notifications content will be loaded here via HTMX -->
        </div>
        <!-- Lazily mount the Map only when navigated to -->
        <template x-if="activeItem === 'map'">
          <div
            x-init="$nextTick(() => { const el = document.getElementById('map-content'); if (el && window.htmx) { htmx.process(el); } })">
            {% include "lab/map.html#map-content" %}
          </div>
        </template>
        <div x-show="activeItem === 'nl-search-page'" id="nl-search-content">
          <!-- Natural language search content will be loaded here via HTMX -->
        </div>
        <div x-show="activeItem === 'profile_settings'" id="profile-settings-content">
          <!-- Profile settings content will be loaded here via HTMX -->
        </div>
      </div>
    </div>
  </main>
</div>

<script>
  function mainController() {
    const initialDetailHtml = JSON.parse(document.getElementById('initial-detail-html').textContent || 'null');
    const initialModelName = JSON.parse(document.getElementById('initial-model-name').textContent || '""');
    const initialAppLabel = JSON.parse(document.getElementById('initial-app-label').textContent || '""');
    const initialPk = JSON.parse(document.getElementById('initial-pk').textContent || '""');
    const displayPrefsEl = document.getElementById('display-preferences');
    const displayPrefs = displayPrefsEl ? JSON.parse(displayPrefsEl.textContent || '{}') : {};

    return {
      activeItem: 'home',
      open: false,
      filters: {},
      sorts: {},
      detailHtml: initialDetailHtml || null,
      viewMode: displayPrefs.default_list_view || 'cards',
      hoverDrawerEnabled: displayPrefs.filter_popup_on_hover ?? true,
      instituteThreshold: 0,
      hpoThreshold: 0,
      loadedSections: new Set(),

      initialModelName: initialModelName,
      initialPk: initialPk,

      clearModal() {
        const modalRoot = document.getElementById('modal-root');
        if (modalRoot) modalRoot.innerHTML = '';
      },

      // Page title mappings for better browser history
      pageTitles: {
        'home': 'Dashboard',
        'overview': 'Overview',
        'individual': 'Individuals',
        'sample': 'Samples',
        'test': 'Tests',
        'analysis': 'Analyses',
        'institution': 'Institutions',
        'project': 'Projects',
        'task': 'Tasks',
        'variant': 'Variants',
        'hpo-term': 'HPO Terms',
        'hpo-network-visualization': 'HPO Network',
        'map': 'Map',
        'nl-search-page': 'AI Search',
        'profile_settings': 'Profile Settings',
        'notifications': 'Notifications',
      },

      updatePageTitle(pageName, itemLabel = null) {
        let title = 'RareIndex';
        if (itemLabel) {
          title = `${itemLabel} | RareIndex`;
        } else if (pageName && this.pageTitles[pageName]) {
          title = `${this.pageTitles[pageName]} | RareIndex`;
        }
        document.title = title;
      },

      init() {
        // this.syncStateFromURL(); // Moved to end of init
        window.addEventListener('popstate', () => { this.clearModal(); this.syncStateFromURL(); });

        this.$watch("filters", (newFilters) => {
          this.updateURL();
          // Global dispatch removed to prevent loops. 
          // Specific inputs will dispatch scoped events.
        });

        // Watch threshold changes and refresh plots
        this.$watch("instituteThreshold", (val) => {
          this.updateURL();
          this.dispatchFiltersUpdated();
        });

        // Watch threshold changes for HPO plot and refresh plots
        this.$watch("hpoThreshold", (val) => {
          this.updateURL();
          this.dispatchFiltersUpdated();
        });

        // Watch viewMode changes and save to localStorage
        this.$watch("viewMode", (newViewMode) => {
          localStorage.setItem('viewMode', newViewMode);
        });

        // Persist the initial preference-driven view mode
        localStorage.setItem('viewMode', this.viewMode);

        // Close modal on page section changes
        this.$watch('activeItem', (val) => { 
          this.clearModal();
          if (val && val !== 'home' && val !== 'overview' && !val.startsWith('detail-')) {
             if (!this.loadedSections.has(val)) {
                 this.$nextTick(() => {
                     window.dispatchEvent(new CustomEvent(`load-${val}`));
                     this.loadedSections.add(val);
                 });
             }
          }
        });

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') this.clearModal();
        });

        // Open filter drawer when pointer hits the right edge of the screen (desktop only) if enabled in preferences
        if (this.hoverDrawerEnabled && window.matchMedia && window.matchMedia('(pointer:fine)').matches) {
          document.addEventListener('mousemove', (e) => {
            const distanceFromRight = window.innerWidth - e.clientX;
            if (distanceFromRight >= 0 && distanceFromRight <= 5 && !this.open) {
              this.open = true;
            }
          });
        }

        // Initial sync
        this.syncStateFromURL();
        
        // Initial dispatch for lazy widgets
        this.$nextTick(() => {
            if (this.activeItem && this.activeItem !== 'home' && this.activeItem !== 'overview' && !this.activeItem.startsWith('detail-')) {
                 if (!this.loadedSections.has(this.activeItem)) {
                     window.dispatchEvent(new CustomEvent(`load-${this.activeItem}`));
                     this.loadedSections.add(this.activeItem);
                 }
            }
        });
      },

      syncStateFromURL() {
        const params = new URLSearchParams(window.location.search);
        this.activeItem = params.get('page') || 'home';
        this.clearModal();

        const newFilters = {};
        const newSorts = {};
        params.forEach((value, key) => {
          if (key.startsWith("filter_")) {
            const filterKey = key.replace("filter_", "");
            if (!value) return;
            const shouldSplit =
              filterKey.includes("_status") ||
              filterKey.includes("_type") ||
              filterKey.includes("_exclude");
            if (shouldSplit) {
              newFilters[filterKey] = value.split(",").filter((v) => v.trim());
            } else {
              newFilters[filterKey] = value;
            }
          }
          if (key.startsWith("sort_")) {
            const sortPayload = key.replace("sort_", "");
            const parts = sortPayload.split("_");
            if (parts.length >= 2) {
              const modelKey = parts.shift();
              const sortKey = parts.join("_");
              const dir = (value || "").toLowerCase();
              if (dir === 'asc' || dir === 'desc') {
                if (!newSorts[modelKey]) newSorts[modelKey] = [];
                newSorts[modelKey].push({ key: sortKey, dir });
              }
            }
          }
        });
        this.filters = newFilters;
        this.sorts = newSorts;

        const th = params.get('institute_threshold');
        this.instituteThreshold = th ? parseInt(th) : 0;

        const hpoTh = params.get('hpo_threshold');
        this.hpoThreshold = hpoTh ? parseInt(hpoTh) : 0;

        if (params.has('pk')) {
          // If we have pre-loaded detail HTML and it matches the requested PK/Model, use it
          const modelName = params.get('model_name');
          const pk = params.get('pk');
          if (this.detailHtml && 
              String(pk) === String(this.initialPk) && 
              modelName === this.initialModelName) {
            this.activeItem = `detail-${this.initialModelName}-${this.initialPk}`;
            // Set title for pre-loaded detail (will be refined after DOM ready)
            this.$nextTick(() => {
              const detailEl = document.getElementById('detail-view');
              const titleEl = detailEl?.querySelector('[data-page-title]') || 
                              detailEl?.querySelector('h1, h2, .detail-title');
              const itemLabel = titleEl?.getAttribute('data-page-title') || 
                               titleEl?.textContent?.trim();
              if (itemLabel) {
                this.updatePageTitle(null, `${itemLabel} | ${modelName}`);
              } else {
                this.updatePageTitle(null, `${modelName} #${pk}`);
              }
            });
          } else {
            this.activeItem = 'detail-loading';
            this.updatePageTitle(null, `${modelName} #${pk}`);
            this.loadDetailView(params);
          }
        } else {
          // Set title for non-detail pages
          this.updatePageTitle(this.activeItem);
        }
        
        // Dispatch update to trigger initial searches if we have filters
        if (Object.keys(this.filters).length > 0) {
             this.$nextTick(() => {
                 this.dispatchFiltersUpdated();
             });
        }

        // Trigger initial load for SPA pages that require HTMX
        if (this.activeItem === 'profile_settings') {
            this.$nextTick(() => {
                htmx.ajax('GET', '{% url "lab:profile_settings" %}', '#profile-settings-content');
            });
        } else if (this.activeItem === 'notifications') {
            this.$nextTick(() => {
                htmx.ajax('GET', '{% url "lab:notifications" %}', '#notifications-content');
            });
        } else if (this.activeItem === 'nl-search-page') {
            this.$nextTick(() => {
                htmx.ajax('GET', '{% url "lab:nl_search_page" %}', '#nl-search-content');
            });
        }
      },

      updateURL() {
        // Don't update URL when on a detail page - detail pages have their own URL format
        // handled by openDetail() which sets /detail/?pk=...&model_name=...&app_label=...
        if (this.activeItem && this.activeItem.startsWith('detail')) {
          return;
        }
        const currentParams = new URLSearchParams(window.location.search);
        const newParams = new URLSearchParams();
        if (this.activeItem && this.activeItem !== 'home') {
          newParams.set('page', this.activeItem);
        }
        for (const modelName in this.filters) {
          if (this.filters[modelName]) {
            // Handle all array values as comma-separated values
            if (Array.isArray(this.filters[modelName])) {
              if (this.filters[modelName].length > 0) {
                newParams.set(`filter_${modelName}`, this.filters[modelName].join(','));
              }
            } else {
              newParams.set(`filter_${modelName}`, this.filters[modelName]);
            }
          }
        }
        if (typeof this.instituteThreshold === 'number' && this.instituteThreshold > 0) {
          newParams.set('institute_threshold', String(this.instituteThreshold));
        }
        if (typeof this.hpoThreshold === 'number' && this.hpoThreshold > 0) {
          newParams.set('hpo_threshold', String(this.hpoThreshold));
        }
        for (const modelKey in this.sorts) {
          const sortArr = this.sorts[modelKey] || [];
          for (const entry of sortArr) {
            if (entry && entry.dir) {
              newParams.set(`sort_${modelKey}_${entry.key}`, entry.dir);
            }
          }
        }
        const newPath = newParams.toString() ? `/?${newParams.toString()}` :
          '/';
        history.pushState({}, "", newPath);
      },

      getGlobalFiltersHxVals(excludeKey = null) {
        const vals = {};
        for (const key in this.filters) {
          const v = this.filters[key];
          if (!v || (Array.isArray(v) && v.length === 0)) continue;
          vals[`filter_${key}`] = Array.isArray(v) ? v.join(',') : v;
        }
        if (typeof this.instituteThreshold === 'number' && this.instituteThreshold > 0 && excludeKey !== 'institute_threshold') {
          vals['institute_threshold'] = String(this.instituteThreshold);
        }
        if (typeof this.hpoThreshold === 'number' && this.hpoThreshold > 0 && excludeKey !== 'hpo_threshold') {
          vals['hpo_threshold'] = String(this.hpoThreshold);
        }
        this.addSortsToVals(vals);
        return JSON.stringify(vals);
      },

      navigateTo(pageName) {
        this.clearModal();
        // Handle notifications navigation
        if (pageName === 'notifications') {
          this.activeItem = 'notifications';
          this.detailHtml = null;
          this.updateURL();
          this.updatePageTitle('notifications');

          // Load notifications content via HTMX
          htmx.ajax('GET', '{% url "lab:notifications" %}', '#notifications-content').then(() => {
            // Content loaded successfully
          });
          return;
        }

        // Handle home navigation
        if (pageName === 'home') {
          this.activeItem = 'home';
          this.detailHtml = null;
          this.updateURL();
          this.updatePageTitle('home');

          // Ask HTMX to reload plots using bound hx-vals (current filters)
          // No need to trigger reload, plots are either already loaded or will update via filter watcher
          return;
        }

        // Handle map navigation
        if (pageName === 'map') {
          this.activeItem = 'map';
          this.detailHtml = null;
          this.updateURL();
          this.updatePageTitle('map');
          return;
        }

        // Handle natural language search navigation
        if (pageName === 'nl-search-page') {
          this.activeItem = 'nl-search-page';
          this.detailHtml = null;
          this.updateURL();
          this.updatePageTitle('nl-search-page');

          // Load natural language search content via HTMX
          htmx.ajax('GET', '{% url "lab:nl_search_page" %}', '#nl-search-content').then(() => {
            // Content loaded successfully
          });
          return;
        }

        // Handle profile settings navigation
        if (pageName === 'profile_settings') {
          this.activeItem = 'profile_settings';
          this.detailHtml = null;
          this.updateURL();
          this.updatePageTitle('profile_settings');

          // Load profile settings content via HTMX
          htmx.ajax('GET', '{% url "lab:profile_settings" %}', '#profile-settings-content').then(() => {
            // Content loaded successfully
          });
          return;
        }

        this.activeItem = pageName;
        this.detailHtml = null;
        this.updateURL();
        this.updatePageTitle(pageName);
      },

      openDetail(pk, modelName, appLabel, itemLabel = null) {
        this.clearModal();
        const newParams = new URLSearchParams();
        newParams.set('pk', pk);
        newParams.set('model_name', modelName);
        newParams.set('app_label', appLabel);
        history.pushState({}, "", `/detail/?${newParams.toString()}`);
        // Set temporary title while loading (will be updated when content loads)
        this.updatePageTitle(null, itemLabel || `${modelName} #${pk}`);
        this.loadDetailView(newParams);
      },

      loadDetailView(params) {
        const pk = params.get('pk');
        const modelName = params.get('model_name');
        const appLabel = params.get('app_label');
        if (pk && modelName && appLabel) {
          const detailUrl = `{% url 'lab:generic_detail' %}?${params.toString()}`;
          htmx.ajax('GET', detailUrl, '#detail-view').then(response => {
            this.detailHtml = response;
            this.activeItem = `detail-${modelName}-${pk}`;
            // Try to extract item label from the loaded content for a better title
            this.$nextTick(() => {
              const detailEl = document.getElementById('detail-view');
              // Look for the title element in the detail view
              const titleEl = detailEl?.querySelector('[data-page-title]') || 
                              detailEl?.querySelector('h1, h2, .detail-title');
              const itemLabel = titleEl?.getAttribute('data-page-title') || 
                               titleEl?.textContent?.trim();
              if (itemLabel) {
                this.updatePageTitle(null, `${itemLabel} | ${modelName}`);
              } else {
                this.updatePageTitle(null, `${modelName} #${pk}`);
              }
            });
          });
        }
      },

      closeDetail() {
        this.detailHtml = null;
        this.clearModal();
        this.goBack();
      },

      goBack() {
        // Use browser history to go back properly
        if (window.history.length > 1) {
          window.history.back();
        } else {
          // Fallback to home if no history
          this.navigateTo('home');
        }
      },

      showNLSearch() {
        this.activeItem = 'nl-search-page';
        this.detailHtml = null;
        this.clearModal();
        this.updateURL();

        // Load natural language search content via HTMX
        htmx.ajax('GET', '{% url 'lab:nl_search_page' %}', '#nl-search-content').then(() => {
          // Content loaded successfully
        });
      },

      getHxVals(appLabel, modelName, page = 1, viewMode = null, card = null, icon_class = null) {
        // Fallback to controller properties if arguments are empty (though typically they are passed from template)
        if (!appLabel && this.appLabel) appLabel = this.appLabel;
        if (!modelName && this.modelName) modelName = this.modelName;

        // If appLabel/modelName are not passed (e.g. from drawer inputs), try to use controller properties if available
        // But mainController doesn't have appLabel/modelName properties for specific models.
        // The issue is that in drawer.html, getHxVals is called with arguments.
        // Wait, in drawer.html: :hx-vals="getHxVals('{{ app_label|default:"lab" }}', '{{ model_name }}', ...)"
        // The template renders these values.
        // If they are missing in the rendered HTML, then the template context is wrong.

        let vals = { app_label: appLabel, model_name: modelName, page: page };
        for (const key in this.filters) {
          if (this.filters[key]) {
            if (key === modelName.toLowerCase()) {
              if (Array.isArray(this.filters[key])) {
                vals['search'] = this.filters[key].join(',');
              } else {
                vals['search'] = this.filters[key];
              }
            } else {
              // Handle all array values as comma-separated values
              if (Array.isArray(this.filters[key])) {
                if (this.filters[key].length > 0) {
                  vals[`filter_${key}`] = this.filters[key].join(',');
                }
              } else {
                vals[`filter_${key}`] = this.filters[key];
              }
            }
          }
        }
        if (viewMode) {
          vals['view_mode'] = viewMode;
        }
        if (card) {
          vals['card'] = card;
        }
        if (icon_class) {
          vals['icon_class'] = icon_class;
        }
        this.addSortsToVals(vals, modelName);
        return JSON.stringify(vals);
      },
      getSelectHxVals(appLabel, modelName, fieldName) {
        let selectedValue = this.filters[fieldName] || '';
        // Ensure selected_value is always sent as a JSON string for consistency
        if (Array.isArray(selectedValue)) {
          selectedValue = JSON.stringify(selectedValue);
        } else if (selectedValue) {
          selectedValue = JSON.stringify([selectedValue]);
        } else {
          selectedValue = JSON.stringify([]);
        }

        let vals = {
          app_label: appLabel,
          model_name: modelName,
          field_name: fieldName,
          selected_value: selectedValue
        };
        for (const key in this.filters) {
          if (key !== fieldName && this.filters[key]) {
            // Handle all array values as comma-separated values
            if (Array.isArray(this.filters[key])) {
              if (this.filters[key].length > 0) {
                vals[`filter_${key}`] = this.filters[key].join(',');
              }
            } else {
              vals[`filter_${key}`] = this.filters[key];
            }
          }
        }
        this.addSortsToVals(vals, modelName);
        return JSON.stringify(vals);
      },
      getStatusHxVals(appLabel, modelName) {
        const statusKey = `${modelName.toLowerCase()}_status`;
        let selectedStatuses = this.filters[statusKey] || [];
        // Ensure statuses is always sent as a JSON string for consistency
        if (Array.isArray(selectedStatuses)) {
          selectedStatuses = JSON.stringify(selectedStatuses);
        } else if (selectedStatuses) {
          selectedStatuses = JSON.stringify([selectedStatuses]);
        } else {
          selectedStatuses = JSON.stringify([]);
        }

        let vals = {
          app_label: appLabel,
          model_name: modelName,
          selected_statuses: selectedStatuses
        };
        for (const key in this.filters) {
          if (key !== statusKey && this.filters[key]) {
            // Handle all array values as comma-separated values
            if (Array.isArray(this.filters[key])) {
              if (this.filters[key].length > 0) {
                vals[`filter_${key}`] = this.filters[key].join(',');
              }
            } else {
              vals[`filter_${key}`] = this.filters[key];
            }
          }
        }
        this.addSortsToVals(vals, modelName);
        return JSON.stringify(vals);
      },
      getTypeHxVals(appLabel, modelName) {
        let vals = {
          app_label: appLabel,
          model_name: modelName,
        };

        // Add all filters including type filters
        for (const key in this.filters) {
          if (this.filters[key]) {
            // Handle all array values as comma-separated values
            if (Array.isArray(this.filters[key])) {
              if (this.filters[key].length > 0) {
                vals[`filter_${key}`] = this.filters[key].join(',');
              }
            } else {
              vals[`filter_${key}`] = this.filters[key];
            }
          }
        }
        this.addSortsToVals(vals, modelName);
        return JSON.stringify(vals);
      },

      addSortsToVals(vals, modelName = null) {
        const key = (modelName || '').toLowerCase();
        if (!key) return;
        const sortArr = key && this.sorts[key] ? this.sorts[key] : [];
        for (const entry of sortArr) {
          if (entry && (entry.dir === 'asc' || entry.dir === 'desc')) {
            vals[`sort_${key}_${entry.key}`] = entry.dir;
          }
        }
      },

      getSortState(sortKey, modelName) {
        const key = (modelName || '').toLowerCase();
        const arr = this.sorts[key] || [];
        const found = arr.find((e) => e.key === sortKey);
        return (found && found.dir) || 'none';
      },

      hasSorts(modelName) {
        const key = (modelName || '').toLowerCase();
        return Array.isArray(this.sorts[key]) && this.sorts[key].length > 0;
      },

      clearSorts(modelName, scope = null) {
        const key = (modelName || '').toLowerCase();
        if (this.sorts[key]) {
          delete this.sorts[key];
          this.updateURL();
          this.$nextTick(() => {
            this.dispatchFiltersUpdated(scope);
          });
        }
      },

      toggleSort(sortKey, modelName, scope = null) {
        const key = (modelName || '').toLowerCase();
        if (!this.sorts[key]) this.sorts[key] = [];
        const arr = this.sorts[key];
        const idx = arr.findIndex((e) => e.key === sortKey);
        if (idx === -1) {
          arr.push({ key: sortKey, dir: 'asc' });
        } else {
          const current = arr[idx].dir;
          if (current === 'asc') {
            arr[idx].dir = 'desc';
          } else {
            arr.splice(idx, 1);
          }
        }
        if (this.sorts[key] && this.sorts[key].length === 0) {
          delete this.sorts[key];
        }
        this.updateURL();
        this.$nextTick(() => {
          this.dispatchFiltersUpdated(scope);
        });
      },

      sortButtonClasses(sortKey, modelName) {
        const state = this.getSortState(sortKey, modelName);
        if (state === 'asc') {
          return 'bg-blue-100 text-blue-800 dark:bg-blue-900/70 dark:text-blue-100 border-blue-300 dark:border-blue-600';
        }
        if (state === 'desc') {
          return 'bg-amber-100 text-amber-800 dark:bg-amber-900/70 dark:text-amber-100 border-amber-300 dark:border-amber-600';
        }
        return 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700';
      },

      sortIconClass(sortKey, modelName) {
        const state = this.getSortState(sortKey, modelName);
        if (state === 'asc') return 'fa-arrow-up';
        if (state === 'desc') return 'fa-arrow-down';
        return 'fa-arrows-up-down';
      },
      toggleTriState(rawValue, includeKey) {
        const value = String(rawValue);
        const excludeKey = `${includeKey}_exclude`;
        const includeList = this.filters[includeKey] || [];
        const excludeList = this.filters[excludeKey] || [];
        const includeIndex = includeList.indexOf(value);
        const excludeIndex = excludeList.indexOf(value);

        if (includeIndex === -1 && excludeIndex === -1) {
          if (!this.filters[includeKey]) {
            this.filters[includeKey] = [];
          }
          this.filters[includeKey].push(value);
          return;
        }

        if (includeIndex > -1) {
          this.filters[includeKey].splice(includeIndex, 1);
          if (this.filters[includeKey].length === 0) {
            delete this.filters[includeKey];
          }
          if (!this.filters[excludeKey]) {
            this.filters[excludeKey] = [];
          }
          if (!this.filters[excludeKey].includes(value)) {
            this.filters[excludeKey].push(value);
          }
          return;
        }

        if (excludeIndex > -1) {
          this.filters[excludeKey].splice(excludeIndex, 1);
          if (this.filters[excludeKey].length === 0) {
            delete this.filters[excludeKey];
          }
        }
      },
      toggleStatus(statusPk, modelName) {
        const statusKey = `${modelName}_status`;
        this.toggleTriState(statusPk, statusKey);
        this.$nextTick(() => {
          this.dispatchFiltersUpdated(modelName);
        });
      },
      toggleType(typePk, filterField) {
        this.toggleTriState(typePk, filterField);
        // Extract model name from filter field (e.g. individual_type -> individual)
        const modelName = filterField.split('_')[0];
        this.$nextTick(() => {
          this.dispatchFiltersUpdated(modelName);
        });
      },
      getFilterState(rawValue, includeKey) {
        const value = String(rawValue);
        const includeList = this.filters[includeKey] || [];
        if (includeList.includes(value)) {
          return 'included';
        }
        const excludeKey = `${includeKey}_exclude`;
        const excludeList = this.filters[excludeKey] || [];
        if (excludeList.includes(value)) {
          return 'excluded';
        }
        return 'none';
      },
      triStateClasses(includeKey, rawValue) {
        const state = this.getFilterState(rawValue, includeKey);
        if (state === 'included') {
          return 'bg-green-500 text-white border-green-500 shadow-sm';
        }
        if (state === 'excluded') {
          return 'bg-red-500 text-white border-red-500 shadow-sm ring-1 ring-red-200 dark:ring-red-500';
        }
        return 'bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 border-gray-300 dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700';
      },
      clearModelStatusFilter(modelName) {
        const statusKey = `${modelName}_status`;
        delete this.filters[statusKey];
        delete this.filters[`${statusKey}_exclude`];
        this.$nextTick(() => {
          this.dispatchFiltersUpdated(modelName);
        });
      },

      // Event-scoped dispatch helper
      dispatchFiltersUpdated(scope = null) {
        const name = scope ? `filters-updated-${scope}` : 'filters-updated';
        window.dispatchEvent(new CustomEvent(name, { detail: { filters: this.filters } }));
      },
    };
  }

  function comboboxController(appLabel, modelName, multiple = true, valueField = 'pk', labelField = '', inputName = '', initialJson = '[]') {
    return {
      appLabel,
      modelName,
      multiple,
      valueField,
      labelField,
      inputName,
      open: false,
      query: '',
      options: [],
      nextPage: null,
      loading: false,
      selected: [], // [{value, label}]
      init() {
        // Initialize from initialJson if provided (for edit forms)
        try {
          const initial = JSON.parse(initialJson || '[]');
          if (Array.isArray(initial)) {
            this.selected = initial.map(v => ({ value: String(v.value ?? v), label: String(v.label ?? v) }));
          }
        } catch (e) { }
        this.$watch('query', () => {
          if (this.open) {
            htmx.trigger(this.$refs.opts, 'combo-query-changed');
          }
        });
        // Ensure defaultSelected on the hidden input reflects initial state for change detection
        this.$nextTick(() => { if (this.$refs.hiddenInput) { this.$refs.hiddenInput.defaultValue = this.hiddenInputValue; } });
      },
      get hiddenInputName() { return this.inputName || `${this.modelName.toLowerCase()}_ids`; },
      get hiddenInputValue() { return JSON.stringify(this.selected.map(o => o.value)); },
      isSelected(value) {
        return this.selected.some(o => String(o.value) === String(value));
      },
      toggleOption(value, label) {
        const idx = this.selected.findIndex(o => String(o.value) === String(value));
        if (idx >= 0) {
          this.selected.splice(idx, 1);
        } else {
          if (!this.multiple) this.selected = [];
          this.selected.push({ value, label });
        }
        if (!this.multiple) {
          this.open = false;
        }
      },
      remove(value) {
        this.selected = this.selected.filter(o => String(o.value) !== String(value));
      },
      clearSelection() {
        this.selected = [];
        this.query = '';
        this.open = false;
      },
      resetToInitial(initialJson) {
        try {
          const initial = JSON.parse(initialJson || '[]');
          if (Array.isArray(initial)) {
            this.selected = initial.map(v => ({ value: String(v.value ?? v), label: String(v.label ?? v) }));
          } else {
            this.selected = [];
          }
          this.query = '';
          this.open = false;
        } catch (e) {
          this.selected = [];
          this.query = '';
          this.open = false;
        }
      },
      getHxVals(page = 1) {
        const excludeIds = this.selected.map(o => o.value);
        const vals = {
          app_label: this.appLabel,
          model_name: this.modelName,
          page: page,
          render: 'combobox',
          exclude_ids: JSON.stringify(excludeIds),
        };
        if (this.query) vals['search'] = this.query;
        if (this.valueField) vals['value_field'] = this.valueField;
        if (this.labelField) vals['label_field'] = this.labelField;
        return JSON.stringify(vals);
      },
    };
  }

  function singleGenericComboboxController(appLabel, modelName, valueField = 'pk', labelField = '', inputName = '', initialValue = '', initialSelectedValue = '') {
    return {
      appLabel,
      modelName,
      valueField,
      labelField,
      inputName,
      open: false,
      query: initialValue || '',
      options: [],
      loading: false,
      selected: null, // {value, label}
      init() {
        // If we have initial data, preselect an option
        if (initialSelectedValue || initialValue) {
          const value = initialSelectedValue || initialValue;
          const label = initialValue || initialSelectedValue || '';
          if (value && label) {
            this.selected = { value, label };
          }
        }
        this.$nextTick(() => { if (this.$refs.hiddenInput) { this.$refs.hiddenInput.defaultValue = this.hiddenInputValue; } });
        this.$watch('query', () => {
          if (this.open) {
            htmx.trigger(this.$refs.opts, 'combo-query-changed');
          }
        });
      },
      get hiddenInputName() { return this.inputName || `${this.modelName.toLowerCase()}_id`; },
      get hiddenInputValue() {
        // If a specific option is selected, submit its value; otherwise submit raw query text
        if (this.selected && this.selected.value !== undefined && this.selected.value !== null && `${this.selected.value}`.length > 0) {
          return `${this.selected.value}`;
        }
        return this.query || '';
      },
      isSelected(value) {
        return this.selected && String(this.selected.value) === String(value);
      },
      toggleOption(value, label) {
        if (this.isSelected(value)) {
          this.selected = null;
        } else {
          this.selected = { value, label };
          this.query = label;
        }
        this.open = false;
        try {
          window.dispatchEvent(new CustomEvent('combobox-selected', { detail: { appLabel: this.appLabel, modelName: this.modelName, valueField: this.valueField, labelField: this.labelField, value, label, inputName: this.inputName } }));
        } catch (e) { }
      },
      clearSelection() {
        this.selected = null;
        this.query = '';
        this.open = false;
      },
      getHxVals(page = 1) {
        const vals = {
          app_label: this.appLabel,
          model_name: this.modelName,
          page: page,
          render: 'combobox',
        };
        if (this.query) vals['search'] = this.query;
        if (this.valueField) vals['value_field'] = this.valueField;
        if (this.labelField) vals['label_field'] = this.labelField;
        return JSON.stringify(vals);
      },
    };
  }

  function hpoController() {
    return {
      hpoThreshold: 3,
      isLoading: false,
      isThresholdValid: true,

      init() {
        this.$watch("hpoThreshold", () => {
          this.isThresholdValid = this.$refs.hpoThresholdInput.checkValidity();
          if (this.isThresholdValid) {
            window.dispatchEvent(new CustomEvent("filters-updated"));
          }
        });
      },

      getHpoVals() {
        let vals = {
          model_name: "Individual",
          threshold: this.hpoThreshold,
        };
        for (const key in this.filters) {
          if (this.filters[key]) {
            // Handle all array values as comma-separated values
            if (Array.isArray(this.filters[key])) {
              if (this.filters[key].length > 0) {
                vals[`filter_${key}`] = this.filters[key].join(',');
              }
            } else {
              vals[`filter_${key}`] = this.filters[key];
            }
          }
        }
        return JSON.stringify(vals);
      }
    };
  }


</script>
{% endblock content %}

{% if initial_detail_html %}
<script>
  document.addEventListener('alpine:init', () => {
    // Wait for Alpine to initialize the component
    const el = document.querySelector('[x-data="mainController()"]');
    if (el) {
       // We need to wait for the component to be fully initialized
       Alpine.nextTick(() => {
         const controller = el.__x.$data;
         if (controller) {
            controller.detailHtml = `{{ initial_detail_html|safe }}`;
            controller.activeItem = 'detail-{{ model_name }}-{{ item.pk }}';
         }
       });
    }
  });
</script>
{% endif %}

{% if initial_nl_search_html %}
<script>
  document.addEventListener('alpine:init', () => {
    const mainController = document.querySelector('[x-data="mainController()"]').__x;
    if (mainController) {
      mainController.showNLSearch();
    }
  });
</script>
{% endif %}

<!-- Hidden family creation form template -->
<div id="family-create-form" class="hidden">
  {% include "lab/crud.html#family-create-form" %}
</div>