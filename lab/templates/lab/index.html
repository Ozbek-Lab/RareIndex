{% extends "lab/base.html" %}
{% load partials %}

{% partialdef indicator %}
  <div x-show="isLoading" x-transition>
    {% if text %}
    <div class="text-center text-gray-500 p-8">{{ text }}</div>
    {% endif %}
    {% if model %}
    <div class="text-center text-gray-500 p-8">Updating {{ model|lower }} results...</div>
    {% endif %}
    <div class="flex justify-center py-4">
      <i class="fas fa-spinner fa-spin fa-2x text-blue-500"></i>
    </div>
  </div>
{% endpartialdef %}

{% partialdef generic-search %}
  <div
    x-data="{ isLoading: false }"
    @htmx:before-request="isLoading = true"
    @htmx:after-request="isLoading = false"
  >
    <input
      class="form-control w-full"
      type="search"
      name="search"
      placeholder="Search {{ model }}"
      {# Bind the input's value directly to the Alpine controller #}
      x-model.debounce.300ms="filters.{{ model|lower }}"
      {# Trigger on input change OR the global event from other filters #}
      hx-get="{% url 'lab:generic_search' %}"
      hx-trigger="input changed delay:200ms, filters-updated from:window, load"
      hx-target="#{{ model|lower }}"
      {# Dynamically generate hx-vals from the Alpine controller #}
      :hx-vals="getHxVals('{{ model }}')"
    />

    {% partial indicator %}
  </div>
{% endpartialdef %}

{% partialdef generic-search-results %}
  {% if items.number == 1 %}
    <div
      class=""
      :class="{'bg-green-500': {{ num_items }} > 0,
                'bg-red-500': {{ num_items }} == 0}"
    >
      Found {{ num_items }} {{ model|lower }}{{ num_items|pluralize }}.
    </div>

    <div class="h-96 overflow-y-auto">
  {% endif %}
    {% for item in items %}
      <div
        {% if forloop.last and items.has_next %}
          hx-get="{% url 'lab:generic_search' %}" hx-trigger="intersect once"
          hx-swap="afterend" hx-target="this" hx-vals='{ "page":
          "{{ items.next_page_number }}", "model": "{{ model }}", "search":
          "{{ search }}"
          {% if all_filters %}
            {% for key, value in all_filters.items %}
              {% if forloop.first %},{% else %},{% endif %}
              "{{ key }}": "{{ value }}"
            {% endfor %}
          {% endif %}
          }'
        {% endif %}
      >
        {% include "lab/"|add:model|lower|add:".html" with item=item %}
      </div>
    {% endfor %}

  {% if items.number == 1 %}
  </div>
  {% endif %}
  {% if not items.has_next and items.number > 1 %}
    {% if num_items != 0 %}
      <div class="bg-orange-300">No more {{ model|lower }}s.</div>
    {% endif %}
  {% endif %}
{% endpartialdef %}

{% partialdef individual-section %}
  <div id="individual-section">
    <h2>Individuals</h2>
    {% with model='Individual' field='cross_ids__id_value' trigger='["Sample", "Institution"]' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="individual">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}

{% partialdef sample-section %}
  <div id="samples-section">
    <h2>Samples</h2>
    {% with model='Sample' field='sample_type__name' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="sample">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}

{% partialdef institution-section %}
  <div id="institution-section">
    <h2>Institutions</h2>
    {% with model='Institution' field='name' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="institution">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}

{% partialdef test-section %}
  <div id="test-section">
    <h2>Tests</h2>
    {% with model='Test' field='name' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="test">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}

{% partialdef project-section %}
  <div id="project-section">
    <h2>Projects</h2>
    {% with model='Project' field='name' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="project">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}

{% partialdef task-section %}
  <div id="task-section">
    <h2>Tasks</h2>
    {% with model='Task' field='name' %}
      {% partial generic-search %}
    {% endwith %}
    <div id="task">{% partial generic-search-results %}</div>
  </div>
{% endpartialdef %}


{% partialdef hpo-section %}
  <div id="hpo-section-wrapper" x-data="hpoController()">
    <div class="flex justify-between items-center mb-2">
      <h2 class="text-2xl font-bold">HPO Visualization</h2>
      {# Use the indicator partial, controlled by the hpoController #}
    </div>
    <div
      id="hpo-visualization-container"
      @htmx:before-request="isLoading = true"
      @htmx:after-request="isLoading = false"
      hx-get="{% url 'lab:hpo_network_visualization' %}"
      hx-trigger="load, filters-updated from:window"
      hx-swap="innerHTML"
      :hx-vals="getHpoVals()"
    >
      {% with text="Initilazing visualization..." %}
        {% partial indicator %}
      {% endwith %}

    </div>
  </div>
{% endpartialdef %}

{% partialdef hpo-network-visualization %}

  {% with text="Updating visualization..." %}
    {% partial indicator %}
  {% endwith %}
  <div class="grid grid-cols-12">
    <div class="col-span-2 h-96 overflow-y-auto">
      {% for individual in individuals %}
        <h3 class="font-semibold text-lg">{{ individual.individual_id }}</h3>
        <ul>
          {% for hpo_term in individual.hpo_terms.all %}
          <li>
            {{ hpo_term }} {{ hpo_term.label }}
          </li>
          {% endfor %}
        </ul>
      {% endfor %}
    </div>
    <div class="col-span-10 space-y-4">
      {% if error %}
        <div class="bg-red-100 p-4 rounded-lg text-red-800"><b>Error:</b> {{ error }}</div>
      {% else %}
        <div class="bg-white shadow rounded-lg p-4">
          <label for="threshold" class="block text-sm font-medium text-gray-700">Consolidation Threshold
            <span x-show="!isThresholdValid" x-transition class="text-red-500 text-sm mt-1">
              Please enter a number between 1 and 24.
            </span>
          </label>
          <input
            type="number" id="threshold" name="threshold"
            placeholder="{{ threshold }}"
            x-model.debounce.500ms="hpoThreshold"
            x-ref="hpoThresholdInput"
            min="1" max="24"
            class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
          >

        </div>
        <div class="bg-white shadow rounded-lg p-4">
          <p class="text-sm">Found <span class="font-bold">{{ term_count }}</span> terms for <span class="font-bold">{{ individual_count }} individuals</span> .</p>
          <div id="plotly-div" style="width: 100%; height: 800px;" class="mt-4"></div>
        </div>
  {# prettier-ignore-start #}
        <script>
          var plotData = {{ plot_json|safe }};
          var plotlyDiv = document.getElementById('plotly-div');
          if (plotlyDiv) { Plotly.newPlot(plotlyDiv, plotData.data, plotData.layout); }
        </script>
  {# prettier-ignore-end #}
      {% endif %}
    </div>
  </div>
{% endpartialdef %}




{% partialdef index %}
  <h1>INDEX PAGE</h1>
{% endpartialdef %}

{% block content %}
  {% partial index %}

  <div x-data="searchController()" class="grid grid-cols-4 gap-4">
    {% partial individual-section %}
    {% partial sample-section %}
    {% partial institution-section %}
    {% partial test-section %}
    {% partial project-section %}
    {% partial task-section %}
  </div>
    {% partial hpo-section %}

  <script>
  function searchController() {
    return {
      filters: {},
      init() {
        const params = new URLSearchParams(window.location.search);
        params.forEach((value, key) => { if (key.startsWith("filter_")) this.filters[key.replace("filter_", "")] = value; });

        this.$watch("filters", (newFilters) => {
          const newParams = new URLSearchParams();
          for (const modelName in newFilters) {
            if (newFilters[modelName]) newParams.set(`filter_${modelName}`, newFilters[modelName]);
          }
          history.pushState({}, "", `?${newParams.toString()}`);

          // Broadcast the event with the filter data in the 'detail' property
          window.dispatchEvent(new CustomEvent("filters-updated", { detail: { filters: newFilters } }));
        });
      },
      getHxVals(modelName) {
        let vals = { model: modelName, search: this.filters[modelName.toLowerCase()] || "" };
        for (const key in this.filters) {
          if (key !== modelName.toLowerCase() && this.filters[key]) {
            vals[`filter_${key}`] = this.filters[key];
          }
        }
        return JSON.stringify(vals);
      },
    };
  }

  function hpoController() {
    return {
      hpoThreshold: 3,
      isThresholdValid: true, // Add this new property to track validity
      isLoading: false,
      mainFilters: {},
      init() {
        // Listen for the broadcast and grab the data from the event detail
        window.addEventListener('filters-updated', (event) => {
            if (event.detail && event.detail.filters) {
                this.mainFilters = event.detail.filters;
            }
        });
        const params = new URLSearchParams(window.location.search);
        if (params.has('threshold')) this.hpoThreshold = parseInt(params.get('threshold'), 3);

        this.$watch('hpoThreshold', () => {
          // First, update the validity state
          this.isThresholdValid = this.$refs.hpoThresholdInput.checkValidity();

          // Only dispatch the update event if the input is valid
          if (this.isThresholdValid) {
              window.dispatchEvent(new CustomEvent("filters-updated"));
          }
        });


        // Trigger initial sync after all components have loaded
        setTimeout(() => window.dispatchEvent(new CustomEvent('filters-updated')), 50);
      },
      getHpoVals() {
          let vals = { model: 'Individual', threshold: this.hpoThreshold };
          for (const key in this.mainFilters) {
              if (this.mainFilters[key]) {
                  vals[key === 'individual' ? 'search' : `filter_${key}`] = this.mainFilters[key];
              }
          }
          return JSON.stringify(vals);
      }
    };
  }
  </script>
{% endblock content %}
