{% extends "lab/base.html" %}
{% load partials %}

{% partialdef nl-search-content inline %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">
                <i class="fas fa-search-plus mr-2"></i>
                Natural Language Search
            </h1>
            <p class="text-lg text-gray-600">
                Ask questions about your data in plain English
            </p>
        </div>

        <!-- Search Form -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8">
            <form 
                hx-post="{% url 'lab:nl_search' %}"
                hx-target="#search-results"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator"
                class="space-y-4"
            >
                {% csrf_token %}
                
                <!-- Query Input -->
                <div>
                    <label for="query" class="block text-sm font-medium text-gray-700 mb-2">
                        What would you like to know?
                    </label>
                    <textarea
                        id="query"
                        name="query"
                        rows="3"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        placeholder="e.g., Show me all samples collected in 2024, How many individuals have samples?, List all tests performed last month..."
                        required
                    ></textarea>
                </div>



                <!-- Submit Button -->
                <div class="flex items-center justify-between">
                    <button
                        type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition duration-200 flex items-center"
                    >
                        <i class="fas fa-search mr-2"></i>
                        Search
                    </button>
                    
                    <!-- Loading Indicator -->
                    <div id="loading-indicator" class="htmx-indicator flex items-center text-blue-600">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                        Processing...
                    </div>
                </div>
            </form>
        </div>

        <!-- Example Queries -->
        <div class="bg-gray-50 rounded-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-lightbulb mr-2"></i>
                Example Queries
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-2">
                    <button 
                        onclick="setQuery('Show me all samples collected in 2024')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>Show me all samples collected in 2024</strong>
                        <div class="text-gray-500 text-xs mt-1">Find samples by collection date</div>
                    </button>
                    
                    <button 
                        onclick="setQuery('How many individuals have samples?')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>How many individuals have samples?</strong>
                        <div class="text-gray-500 text-xs mt-1">Count individuals with samples</div>
                    </button>
                    
                    <button 
                        onclick="setQuery('List all tests performed last month')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>List all tests performed last month</strong>
                        <div class="text-gray-500 text-xs mt-1">Recent test activity</div>
                    </button>
                </div>
                
                <div class="space-y-2">
                    <button 
                        onclick="setQuery('Show individuals with more than 3 samples')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>Show individuals with more than 3 samples</strong>
                        <div class="text-gray-500 text-xs mt-1">High sample count individuals</div>
                    </button>
                    
                    <button 
                        onclick="setQuery('What are the most common sample types?')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>What are the most common sample types?</strong>
                        <div class="text-gray-500 text-xs mt-1">Sample type distribution</div>
                    </button>
                    
                    <button 
                        onclick="setQuery('Show all pending tasks')"
                        class="text-left w-full p-3 bg-white rounded border hover:bg-gray-50 transition duration-200 text-sm"
                    >
                        <strong>Show all pending tasks</strong>
                        <div class="text-gray-500 text-xs mt-1">Task management</div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="search-results" class="min-h-64">
            <!-- Results will be loaded here via HTMX -->
        </div>
    </div>
</div>

<script>
function setQuery(query) {
    document.getElementById('query').value = query;
    document.getElementById('query').focus();
}
</script>
{% endpartialdef %}

{% partialdef nl-search-result %}
<div class="bg-white rounded-lg shadow-md p-6">
    <!-- Query Info -->
    <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                Search Results
            </h3>
            <span class="text-sm text-gray-500">
                <i class="fas fa-clock mr-1"></i>
                {{ result|length }} results
            </span>
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-4">
            <div class="flex items-start">
                <i class="fas fa-question-circle text-blue-500 mt-1 mr-3"></i>
                <div class="flex-1">
                    <h4 class="font-medium text-blue-900 mb-2">Your Question:</h4>
                    <p class="text-blue-800">{{ query }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated SQL -->
    {% if sql %}
    <div class="mb-6">
        <div class="flex items-center justify-between mb-3">
            <h4 class="font-medium text-gray-900">
                <i class="fas fa-code mr-2"></i>
                Generated SQL Query
            </h4>
            <button 
                onclick="toggleSql()"
                class="text-sm text-blue-600 hover:text-blue-800 flex items-center"
            >
                <i class="fas fa-eye mr-1"></i>
                <span id="sql-toggle-text">Show SQL</span>
            </button>
        </div>
        
        <div id="sql-code" class="hidden">
            <pre class="bg-gray-100 border border-gray-300 rounded-md p-4 text-sm overflow-x-auto"><code>{{ sql }}</code></pre>
        </div>
    </div>
    {% endif %}

    <!-- Results -->
    <div class="space-y-4">
        <h4 class="font-medium text-gray-900">
            <i class="fas fa-table mr-2"></i>
            Results
        </h4>
        
        {% if result %}
            <div class="bg-gray-50 border border-gray-200 rounded-md p-4">
                <div class="prose max-w-none">
                    {{ result|linebreaks }}
                </div>
            </div>
        {% else %}
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
                <div class="flex items-center">
                    <i class="fas fa-info-circle text-yellow-500 mr-2"></i>
                    <span class="text-yellow-800">No results found for your query.</span>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Try Another Query -->
    <div class="mt-6 pt-6 border-t border-gray-200">
        <div class="text-center">
            <button 
                onclick="clearResults()"
                class="bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md transition duration-200"
            >
                <i class="fas fa-plus mr-2"></i>
                Try Another Query
            </button>
        </div>
    </div>
</div>

<script>
function toggleSql() {
    const sqlCode = document.getElementById('sql-code');
    const toggleText = document.getElementById('sql-toggle-text');
    const icon = toggleText.previousElementSibling;
    
    if (sqlCode.classList.contains('hidden')) {
        sqlCode.classList.remove('hidden');
        toggleText.textContent = 'Hide SQL';
        icon.className = 'fas fa-eye-slash mr-1';
    } else {
        sqlCode.classList.add('hidden');
        toggleText.textContent = 'Show SQL';
        icon.className = 'fas fa-eye mr-1';
    }
}

function clearResults() {
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('query').value = '';
    document.getElementById('query').focus();
}
</script>
{% endpartialdef %}

{% partialdef nl-search-error %}
<div class="bg-white rounded-lg shadow-md p-6">
    <!-- Error Header -->
    <div class="mb-6">
        <div class="flex items-center mb-4">
            <i class="fas fa-exclamation-triangle text-red-500 mr-3 text-xl"></i>
            <h3 class="text-lg font-semibold text-gray-900">Search Error</h3>
        </div>
    </div>

    <!-- Error Message -->
    <div class="bg-red-50 border border-red-200 rounded-md p-4 mb-6">
        <div class="flex items-start">
            <i class="fas fa-times-circle text-red-500 mt-1 mr-3"></i>
            <div class="flex-1">
                <h4 class="font-medium text-red-900 mb-2">Error Details:</h4>
                <p class="text-red-800">{{ error }}</p>
            </div>
        </div>
    </div>

    <!-- Troubleshooting Tips -->
    <div class="bg-blue-50 border border-blue-200 rounded-md p-4 mb-6">
        <div class="flex items-start">
            <i class="fas fa-lightbulb text-blue-500 mt-1 mr-3"></i>
            <div class="flex-1">
                <h4 class="font-medium text-blue-900 mb-2">Troubleshooting Tips:</h4>
                <ul class="text-blue-800 text-sm space-y-1">
                    <li>• Make sure Ollama is running with the selected model</li>
                    <li>• Try rephrasing your question more simply</li>
                    <li>• Check that your question relates to the available data</li>
                    <li>• Try a different AI model from the dropdown</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Common Issues -->
    <div class="mb-6">
        <h4 class="font-medium text-gray-900 mb-3">
            <i class="fas fa-question-circle mr-2"></i>
            Common Issues
        </h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-gray-50 rounded-md p-3">
                <h5 class="font-medium text-gray-900 mb-2">Ollama Not Running</h5>
                <p class="text-sm text-gray-600">
                    Make sure Ollama is installed and running. Try: <code class="bg-gray-200 px-1 rounded">ollama run sqlcoder</code>
                </p>
            </div>
            <div class="bg-gray-50 rounded-md p-3">
                <h5 class="font-medium text-gray-900 mb-2">Model Not Available</h5>
                <p class="text-sm text-gray-600">
                    The selected model might not be installed. Try: <code class="bg-gray-200 px-1 rounded">ollama list</code>
                </p>
            </div>
        </div>
    </div>

    <!-- Try Again Button -->
    <div class="text-center">
        <button 
            onclick="clearResults()"
            class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-6 rounded-md transition duration-200"
        >
            <i class="fas fa-redo mr-2"></i>
            Try Again
        </button>
    </div>
</div>

<script>
function clearResults() {
    document.getElementById('search-results').innerHTML = '';
    document.getElementById('query').focus();
}
</script>
{% endpartialdef %}

{% block content %}
<!-- This template is now used for both full page and partial rendering -->
{% partial nl-search-content %}
{% endblock %} 