{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}RareIndex{% endblock %}</title>
    
    <!-- DaisyUI & Tailwind (Local) -->
    <link rel="preload" href="{% static 'vendor/css/daisyui.min.css' %}" as="style">
    <link href="{% static 'vendor/css/daisyui.min.css' %}" rel="stylesheet" type="text/css" />
    
    <link rel="preload" href="{% static 'css/output.css' %}" as="style">
    <link href="{% static 'css/output.css' %}" rel="stylesheet" type="text/css" />

    <style>
        .font-sans { font-family: 'Inter', sans-serif !important; }
        :root { --font-sans: 'Inter', sans-serif; }
        body { font-family: 'Inter', sans-serif; }
    </style>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="{% static 'vendor/fontawesome/css/all.min.css' %}">
    
    <!-- HTMX -->
    <script defer src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Alpine.js -->
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/intersect@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        /* Chrome, Edge, Safari (Webkit) */
        html::-webkit-scrollbar,
        body::-webkit-scrollbar,
        *::-webkit-scrollbar {
            width: 8px !important;
            height: 8px !important;
            display: block !important;
        }

        html::-webkit-scrollbar-track,
        body::-webkit-scrollbar-track,
        *::-webkit-scrollbar-track {
            background: transparent !important;
        }

        html::-webkit-scrollbar-thumb,
        body::-webkit-scrollbar-thumb,
        *::-webkit-scrollbar-thumb {
            background-color: #666666 !important; /* Fallback */
            background-color: oklch(var(--b3)) !important;
            border-radius: 20px !important;
            border: 2px solid transparent !important; /* Forces some browsers to respect color */
            background-clip: content-box !important;
        }

        html::-webkit-scrollbar-thumb:hover,
        body::-webkit-scrollbar-thumb:hover,
        *::-webkit-scrollbar-thumb:hover {
            background-color: #333333 !important; /* Fallback */
            background-color: oklch(var(--bc) / 0.5) !important;
        }

        /* Firefox */
        @supports (-moz-appearance: none) {
            html, body, * {
                scrollbar-width: thin !important;
                scrollbar-color: #666666 transparent !important; /* Fallback */
                scrollbar-color: oklch(var(--b3)) transparent !important;
            }
        }
    </style>
</head>
<body class="bg-base-100 min-h-screen flex flex-col" x-data="{ 
    sidebarOpen: localStorage.getItem('sidebarOpen') === 'true',
    theme: '{{ user_theme|default:"light" }}',
    init() {
        document.documentElement.setAttribute('data-theme', this.theme);
        this.$watch('theme', val => {
            document.documentElement.setAttribute('data-theme', val);
            // Local storage for quick flash prevention on load
            localStorage.setItem('theme', val);
        });
        this.$watch('sidebarOpen', val => {
            localStorage.setItem('sidebarOpen', val);
        });
    }
}" x-init="init()">
    

    <div class="drawer flex-1" :class="{ 'lg:drawer-open': sidebarOpen }">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />
        <div class="drawer-content flex flex-col">
            {% if user.is_authenticated %}
            <!-- Desktop Sidebar Expander (Thin band on left) -->
            <div 
                @click="sidebarOpen = true" 
                class="fixed inset-y-0 left-0 w-6 bg-base-200 hover:bg-base-300 cursor-pointer flex items-center justify-center z-10 transition-colors hidden lg:flex"
                :class="{ 'hidden': sidebarOpen }"
                title="Expand Sidebar"
            >
                 <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="w-4 h-4 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </div>
            {% endif %}
            
            <!-- Page content here -->
            {% block content %}
            {% endblock %}
        </div> 
        <div class="drawer-side z-20">
            <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label> 
            <!-- Sidebar -->
            {% if user.is_authenticated %}
                {% include "lab/partials/sidebar.html" %}
            {% endif %}
        </div>
    </div>
    
    <!-- Notes Modal -->
    <dialog id="notes-modal" class="modal">
      <div class="modal-box w-11/12 max-w-3xl h-[80vh] flex flex-col p-4 bg-white dark:bg-gray-800">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <h3 class="font-bold text-lg mb-4 text-gray-900 dark:text-gray-100">Notes</h3>
        <div id="notes-modal-content" class="flex-1 overflow-y-auto">
            <!-- Content loaded via HTMX -->
            <div class="flex justify-center items-center h-full">
                <span class="loading loading-spinner loading-md"></span>
            </div>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>
    
    <!-- Generic Modal for Samples, Tests, etc. -->
    <dialog id="generic-modal" class="modal">
      <div class="modal-box w-11/12 max-w-2xl bg-base-100">
        <form method="dialog">
          <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">✕</button>
        </form>
        <div id="generic-modal-content">
            <div class="flex justify-center p-8">
                <span class="loading loading-spinner loading-md"></span>
            </div>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Document Preview Drawer (Right Side) -->
    <div x-data="{ open: false }" 
         @keydown.escape.window="open = false"
         @open-preview.window="open = true"
         class="relative z-[100]">
        
        <!-- Backdrop -->
        <div x-show="open" 
             x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0"
             x-transition:enter-end="opacity-100"
             x-transition:leave="transition ease-in duration-200"
             x-transition:leave-start="opacity-100"
             x-transition:leave-end="opacity-0"
             class="fixed inset-0 bg-black/20 backdrop-blur-[2px] pointer-events-auto"
             @click="open = false"></div>

        <!-- Panel -->
        <div x-show="open"
             x-transition:enter="transition ease-out duration-300 transform"
             x-transition:enter-start="translate-x-full"
             x-transition:enter-end="translate-x-0"
             x-transition:leave="transition ease-in duration-200 transform"
             x-transition:leave-start="translate-x-0"
             x-transition:leave-end="translate-x-full"
             class="fixed inset-y-0 right-0 w-[90vw] md:w-[600px] lg:w-[800px] bg-base-100 shadow-2xl pointer-events-auto flex flex-col border-l border-base-200 z-[101]">
            
            <div id="preview-drawer-content" class="flex-1 flex flex-col h-full overflow-hidden">
                <!-- Content loaded via HTMX -->
                <div class="flex justify-center items-center h-full">
                    <span class="loading loading-spinner loading-lg text-primary"></span>
                </div>
            </div>
        </div>

        <!-- Hidden Input to integrate with existing trigger (if needed) -->
        <input id="preview-drawer" type="checkbox" class="hidden" x-model="open">
    </div>

    <script>
        document.body.addEventListener('htmx:configRequest', (event) => {
            event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}';
        });
    </script>
</body>
</html>
